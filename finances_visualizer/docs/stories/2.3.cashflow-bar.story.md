# Story 2.3: Cash Flow Bar Chart

## Story Metadata

```yaml
epic: 2
story: 3
title: Cash Flow Bar Chart
status: Draft
created: 2026-02-03
estimated_days: 1.5
complexity: Medium

clickup:
  task_id: ""
  epic_task_id: ""
  list: "Backlog"
  url: ""
  last_sync: ""
```

---

## User Story

**As a** user,
**I want** to see income vs expenses per month as a bar chart,
**so that** I can compare my cash flow over time.

---

## Acceptance Criteria

1. Grouped bar chart (green = income, red = expense) by month
2. X-axis: Month labels (Jan, Fev, Mar...)
3. Y-axis: Currency values (BRL)
4. Hover bar: tooltip with exact amounts
5. Net line overlay: shows difference (income - expense)
6. Animation: bars grow up from zero
7. Handles months with no data (shows zero)
8. Zoomable (click/drag to select date range)

---

## Requirements Mapping

| AC | Functional Requirement | Notes |
|----|----------------------|-------|
| AC1 | FR5 | Bar chart |
| AC2 | FR5 | X-axis labels |
| AC3 | FR5 | Y-axis values |
| AC4 | FR5, FR7 | Tooltip |
| AC5 | FR5 | Net line |
| AC6 | UI Design Goals | Animation |
| AC7 | FR11 | No data handling |
| AC8 | FR7 | Interactivity |

---

## ðŸ¤– CodeRabbit Integration

> **CodeRabbit Integration**: Enabled

### Story Type Analysis

- **Primary Type**: Frontend
- **Secondary Type(s)**: None
- **Complexity**: Medium (grouped bars + line overlay)

### Specialized Agent Assignment

- **Primary Agents**: @dev (chart component)
- **Supporting Agents**: None

### Quality Gate Tasks

- [ ] Pre-Commit (@dev): Run `coderabbit --prompt-only -t uncommitted` before marking story complete
- [ ] Pre-PR (@github-devops): Run `coderabbit --prompt-only --base main` before creating pull request

### CodeRabbit Focus Areas

**Primary Focus:**
- Recharts BarChart configured for grouped bars
- Colors match PRD (green income, red expense)
- Net line overlays correctly on bars
- Tooltip displays both income and expense

**Secondary Focus:**
- Month labels are localized (Jan, Fev, etc.)
- Zero months don't break the chart
- Zoom/drag interaction works

### Self-Healing Configuration

```
Expected Self-Healing:
  - Primary Agent: @dev (light mode)
  - Max Iterations: 2
  - Timeout: 15 minutes
  - Severity Filter: CRITICAL only
```

---

## Dev Notes

### Data Structure [Source: Story 1.5]

```typescript
// Input: MonthlySummary[] from aggregation
interface MonthlySummary {
  month: string;       // "2024-01"
  income: number;
  expense: number;
  balance: number;
  transactionCount: number;
}
```

### Chart Type [Source: PRD]

**Grouped Bar Chart** - Two bars per month (income, expense)

### Component Structure

Location: `src/components/CashFlowBarChart.tsx`

**Props:**
```typescript
interface CashFlowBarChartProps {
  data: MonthlySummary[];
  onDateRangeSelect?: (start: Date, end: Date) => void;
}
```

### Recharts Implementation

```tsx
<BarChart
  width={800}
  height={400}
  data={data}
  margin={{ top: 20, right: 30, left: 20, bottom: 5 }}
>
  <CartesianGrid strokeDasharray="3 3" stroke="#334155" />
  <XAxis
    dataKey="month"
    tickFormatter={(month) => formatMonthLabel(month)}  // "2024-01" â†’ "Jan"
    stroke="#64748b"
  />
  <YAxis
    tickFormatter={(value) => formatBRLShort(value)}  // "1000" â†’ "R$ 1k"
    stroke="#64748b"
  />
  <Tooltip
    content={<CustomTooltip />}
    formatter={(value: number, name: string) => [
      formatBRL(value),
      name === 'income' ? 'Receita' : 'Despesa'
    ]}
  />
  <Legend />
  <Bar dataKey="income" fill="#10b981" name="Receita" radius={[4, 4, 0, 0]} />
  <Bar dataKey="expense" fill="#f43f5e" name="Despesa" radius={[4, 4, 0, 0]} />

  {/* Net line overlay */}
  <Line
    type="monotone"
    dataKey="balance"
    stroke="#6366f1"
    strokeWidth={2}
    dot={{ fill: '#6366f1', r: 4 }}
    name="Saldo"
  />
</BarChart>
```

### Month Label Formatter [AC: 2]

```typescript
function formatMonthLabel(monthStr: string): string {
  // "2024-01" â†’ "Jan"
  const [, monthNum] = monthStr.split('-');
  const months = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun',
                  'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
  return months[parseInt(monthNum) - 1] || monthStr;
}
```

### Short Currency Formatter [AC: 3]

```typescript
function formatBRLShort(value: number): string {
  if (Math.abs(value) >= 1000) {
    return `R$ ${(value / 1000).toFixed(1)}k`;
  }
  return `R$ ${value.toFixed(0)}`;
}
```

### Net Line Overlay [AC: 5]

- Use same data as bars
- Plot balance values
- Different color (purple)
- On separate Y-axis or scaled to fit

### Animation [AC: 6]

```tsx
<Bar
  isAnimationActive={true}
  animationBegin={200}  // Stagger after donut
  animationDuration={600}
  animationEasing="ease-out"
/>
```

### Zero Month Handling [AC: 7]

If a month has no data:
- Include in chart with zero values
- Prevents gaps in timeline
- Bars render with zero height

### Zoom/Drag Interaction [AC: 8]

Use Recharts `Brush` component:

```tsx
<Brush
  dataKey="month"
  height={30}
  stroke="#6366f1"
  fill="#6366f1"
  onChange={(range) => {
    if (range) {
      const [start, end] = range;
      onDateRangeSelect?.(new Date(start), new Date(end));
    }
  }}
/>
```

---

## Tasks / Subtasks

### Task 1: Create Chart Component (AC: 1)

- Create `src/components/CashFlowBarChart.tsx`
- Implement BarChart with Recharts
- Configure grouped bars (income, expense)

### Task 2: Configure Axes (AC: 2, 3)

- Add XAxis with month labels
- Add YAxis with currency format
- Style with dark theme colors

### Task 3: Add Tooltip (AC: 4)

- Create custom tooltip
- Show income and expense values
- Format as BRL

### Task 4: Add Net Line Overlay (AC: 5)

- Add Line chart for balance
- Style with different color
- Ensure renders on top of bars

### Task 5: Implement Animation (AC: 6)

- Configure bar growth animation
- Bars grow from zero
- Stagger after previous charts

### Task 6: Handle Zero Data (AC: 7)

- Ensure months with no data display
- Show bars with zero height
- No gaps in timeline

### Task 7: Add Zoom/Drag (AC: 8)

- Implement Brush component
- Wire up date range callback
- Style brush to match theme

### Task 8: Create Tests (Coverage)

- Test chart rendering
- Test month label formatting
- Test tooltip display
- Test net line calculation
- Test zoom interaction

---

## Testing Strategy

### Unit Tests (Vitest)

- Month label formatting
- Short currency formatting
- Component renders with data

### Visual Tests

- Bars display correctly
- Colors match PRD
- Net line visible

### Manual Testing

1. Upload CSV with multiple months
2. Verify bars display income/expense
3. Check net line shows balance
4. Hover bars â†’ tooltip appears
5. Test zoom/drag selection
6. Verify month labels in Portuguese

---

## Definition of Done

- [x] All acceptance criteria met
- [x] Grouped bar chart displays monthly data
- [x] Month labels in Portuguese
- [x] Currency formatted correctly
- [x] Tooltip shows amounts
- [x] Net line overlay working
- [x] Animation smooth
- [x] Zero months handled
- [x] Zoom/drag working
- [x] Tests passing
- [x] CodeRabbit review passed

---

*Story created by AIOS Framework*
*Scrum Master: @sm (River)*
*Date: 2026-02-03*
