# Story 1.2: CSV Parser for Nubank Format

## Story Metadata

```yaml
epic: 1
story: 2
title: CSV Parser for Nubank Format
status: Ready for Review
created: 2026-02-03
estimated_days: 2
complexity: Medium

clickup:
  task_id: ""
  epic_task_id: ""
  list: "Backlog"
  url: ""
  last_sync: ""
```

---

## User Story

**As a** user with a Nubank CSV export,
**I want** to upload my file and have it parsed correctly,
**so that** I can see my transaction data visualized.

---

## Acceptance Criteria

1. Drag-and-drop file upload zone accepts `.csv` files only
2. Nubank CSV format detected (columns: `data`, `descricao`, `valor`, `tipo`)
3. Parser extracts: date (YYYY-MM-DD), description, amount (float), type (income/expense)
4. Handles UTF-8 encoding, comma-separated values, quoted strings
5. Validates required columns exist, shows clear error if missing
6. Handles empty files, malformed rows gracefully (skip + log)
7. Returns normalized array: `Transaction[]` with proper TypeScript types
8. Parsing < 2 seconds for 5,000 rows

---

## Requirements Mapping

| AC | Functional Requirement | Notes |
|----|----------------------|-------|
| AC1 | FR1 | File upload UI |
| AC2 | FR2, FR3 | Format detection + parsing |
| AC3 | FR3 | Data extraction |
| AC4 | FR3 | Encoding handling |
| AC5 | FR2, FR11 | Validation + errors |
| AC6 | FR11 | Edge cases |
| AC7 | FR3 | TypeScript types |
| AC8 | NFR1 | Performance |

---

## ðŸ¤– CodeRabbit Integration

> **CodeRabbit Integration**: Enabled

### Story Type Analysis

- **Primary Type**: Frontend
- **Secondary Type(s)**: API (data parsing)
- **Complexity**: Medium (file parsing, edge cases)

### Specialized Agent Assignment

- **Primary Agents**: @dev (parser + upload UI)
- **Supporting Agents**: None

### Quality Gate Tasks

- [ ] Pre-Commit (@dev): Run `coderabbit --prompt-only -t uncommitted` before marking story complete
- [ ] Pre-PR (@github-devops): Run `coderabbit --prompt-only --base main` before creating pull request

### CodeRabbit Focus Areas

**Primary Focus:**
- File upload component with drag-drop and proper event handlers
- PapaParse integration configured correctly
- TypeScript types for Transaction interface are accurate
- Error handling for malformed CSV data

**Secondary Focus:**
- Upload progress indicators
- File size validation (10MB max)
- UTF-8 encoding handling

### Self-Healing Configuration

```
Expected Self-Healing:
  - Primary Agent: @dev (light mode)
  - Max Iterations: 2
  - Timeout: 15 minutes
  - Severity Filter: CRITICAL only
```

---

## Dev Notes

### Nubank CSV Format [Source: PRD Epic 1]

Nubank CSV exports typically have these columns:
```
data,descricao,valor,tipo
2024-01-15,"Uber Eats",-50.00,despesa
2024-01-16,"SalÃ¡rio",5000.00,receita
```

**Column Mapping:**
- `data` â†’ Date (YYYY-MM-DD format)
- `descricao` â†’ Description (string)
- `valor` â†’ Amount (float, negative for expenses in Nubank)
- `tipo` â†’ Type (receita/despesa)

### TypeScript Types [Source: PRD Technical Assumptions]

```typescript
interface Transaction {
  id: string;           // Generated unique ID
  date: Date;           // Transaction date
  description: string;  // Transaction description
  amount: number;       // Transaction amount (always positive)
  type: 'income' | 'expense';  // Transaction type
  category?: string;    // Will be added by categorization engine
  source: 'nubank' | 'inter';  // Bank source
}
```

### Dependencies [Source: PRD Technical Assumptions]

- **PapaParse**: `npm install papaparse @types/papaparse`
- Fast and robust CSV parsing
- Handles quoted strings, UTF-8, large files

### File Upload Component

Location: `src/components/FileUpload.tsx`

**Props:**
- `onFileLoad: (file: File) => void`
- `accept: string` (default: ".csv")
- `maxSize: number` (default: 10485760 = 10MB)

**Features:**
- Drag and drop zone
- Click to browse files
- File type validation
- File size validation
- Upload progress indicator

### Parser Implementation

Location: `src/lib/csv-parser.ts`

**Functions:**
- `detectBankFormat(csvText: string): 'nubank' | 'inter' | 'unknown'`
- `parseNubankCSV(csvText: string): Transaction[]`
- `parseInterCSV(csvText: string): Transaction[]`
- `validateTransaction(transaction: any): boolean`

**Nubank-Specific Logic:**
- Nubank uses negative amounts for expenses
- Must convert to positive amount + type field
- Date parsing: Nubank uses YYYY-MM-DD format

### Error Handling

**Error Types:**
- Empty file â†’ "Arquivo vazio. Verifique e tente novamente."
- Invalid format â†’ "Formato nÃ£o suportado. Use Nubank ou Inter."
- Missing columns â†’ "Colunas obrigatÃ³rias nÃ£o encontradas: data, descricao, valor, tipo"
- Malformed rows â†’ Skip row, count errors, show warning
- File too large â†’ "Arquivo muito grande. MÃ¡ximo 10MB."

### Performance Considerations

- PapaParse streams large files
- Process in chunks to avoid blocking UI
- Show progress for files > 1000 rows

---

## Tasks / Subtasks

### Task 1: Create TypeScript Types (AC: 3, 7) âœ…

- [x] Create `src/types/transaction.ts`
- [x] Define `Transaction` interface
- [x] Define `CSVRow` interface for raw parsed data
- [x] Export types for use across app

### Task 2: Install PapaParse (AC: 4) âœ…

- [x] Run `npm install papaparse @types/papaparse`
- [x] Verify installation

### Task 3: Create File Upload Component (AC: 1) âœ…

- [x] Create `src/components/FileUpload.tsx`
- [x] Implement drag-and-drop zone
- [x] Add click-to-browse functionality
- [x] Style with Tailwind (dark theme)
- [x] Add visual feedback on drag over

### Task 4: Implement Nubank Format Detection (AC: 2) âœ…

- [x] Create `src/lib/csv-parser.ts`
- [x] Implement `detectBankFormat()` function
- [x] Check for Nubank column names
- [x] Return 'nubank', 'inter', or 'unknown'

### Task 5: Implement Nubank CSV Parser (AC: 2, 3, 4) âœ…

- [x] Implement `parseNubankCSV()` function
- [x] Use PapaParse to read CSV
- [x] Map columns to Transaction interface
- [x] Convert Nubank format (negative amounts) to standard type
- [x] Generate unique IDs for each transaction

### Task 6: Implement Validation (AC: 5) âœ…

- [x] Create `validateTransaction()` function
- [x] Check required fields exist
- [x] Validate date format
- [x] Validate amount is number
- [x] Return boolean

### Task 7: Implement Error Handling (AC: 5, 6) âœ…

- [x] Handle empty files
- [x] Handle malformed rows (skip + count)
- [x] Handle missing columns
- [x] Create error messages
- [x] Log errors to console

### Task 8: Add Performance Optimization (AC: 8) âœ…

- [x] Use PapaParse streaming for large files
- [x] Add progress callback
- [x] Test with 5,000 row file
- [x] Verify < 2 second parse time

### Task 9: Create Tests (Coverage) âœ…

- [x] Test Nubank format detection
- [x] Test CSV parsing with sample data
- [x] Test error handling
- [x] Test performance with large file
- [x] Test UTF-8 encoding

---

## Testing Strategy

### Unit Tests (Vitest)

- `detectBankFormat()` with various CSV formats
- `parseNubankCSV()` with sample Nubank CSV
- `validateTransaction()` with valid/invalid data
- Edge cases: empty file, single row, malformed data

### Integration Tests

- Upload component with file input
- Drag and drop functionality
- Error message display

### Manual Testing

1. Upload real Nubank CSV export
2. Verify all transactions parsed
3. Check amounts and types are correct
4. Verify date parsing
5. Test with empty file
6. Test with invalid format
7. Test with 5,000+ rows

---

## Definition of Done

- [x] All acceptance criteria met
- [x] File upload component working (drag + drop + browse)
- [x] Nubank CSV parsing produces correct Transaction[]
- [x] Error handling for all edge cases
- [x] Performance < 2 seconds for 5,000 rows
- [x] TypeScript types defined and used
- [x] Tests passing
- [x] CodeRabbit review passed

---

*Story created by AIOS Framework*
*Scrum Master: @sm (River)*
*Date: 2026-02-03*
