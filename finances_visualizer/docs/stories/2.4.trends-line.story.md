# Story 2.4: Trends Line Chart

## Story Metadata

```yaml
epic: 2
story: 4
title: Trends Line Chart
status: Draft
created: 2026-02-03
estimated_days: 2
complexity: Medium

clickup:
  task_id: ""
  epic_task_id: ""
  list: "Backlog"
  url: ""
  last_sync: ""
```

---

## User Story

**As a** user,
**I want** to see a line chart showing expense trends over time,
**so that** I can spot patterns and anomalies.

---

## Acceptance Criteria

1. Line chart with smooth curves (Catmull-Rom interpolation)
2. One line per category (top 5 categories, others grouped)
3. X-axis: Timeline (daily, weekly, or monthly based on range)
4. Y-axis: Currency values
5. Hover: crosshair with tooltip for all visible lines
6. Click legend item: toggle line visibility
7. Annotation dots for outliers (>2std from mean)
8. Gradient fill under lines for visual appeal

---

## Requirements Mapping

| AC | Functional Requirement | Notes |
|----|----------------------|-------|
| AC1 | FR5 | Line chart |
| AC2 | FR5 | Multiple lines |
| AC3 | FR5 | Timeline axis |
| AC4 | FR5 | Currency axis |
| AC5 | FR5, FR7 | Crosshair tooltip |
| AC6 | FR5, FR7 | Legend toggle |
| AC7 | FR5 | Outlier detection |
| AC8 | UI Design Goals | Visual polish |

---

## ü§ñ CodeRabbit Integration

> **CodeRabbit Integration**: Enabled

### Story Type Analysis

- **Primary Type**: Frontend
- **Secondary Type(s)**: API (data transformation)
- **Complexity**: Medium (multiple lines, outliers)

### Specialized Agent Assignment

- **Primary Agents**: @dev (chart + data processing)
- **Supporting Agents**: None

### Quality Gate Tasks

- [ ] Pre-Commit (@dev): Run `coderabbit --prompt-only -t uncommitted` before marking story complete
- [ ] Pre-PR (@github-devops): Run `coderabbit --prompt-only --base main` before creating pull request

### CodeRabbit Focus Areas

**Primary Focus:**
- Recharts LineChart configured for multiple lines
- Catmull-Rom interpolation produces smooth curves
- Top 5 categories selected correctly
- Outlier detection algorithm (>2std) accurate

**Secondary Focus:**
- Legend toggle works per line
- Crosshair tooltip shows all line values
- Gradient fill doesn't obscure data

### Self-Healing Configuration

```
Expected Self-Healing:
  - Primary Agent: @dev (light mode)
  - Max Iterations: 2
  - Timeout: 15 minutes
  - Severity Filter: CRITICAL only
```

---

## Dev Notes

### Data Preparation [Source: Story 1.5]

Need to transform Transaction[] into time-series data by category:

```typescript
interface TrendData {
  date: string;  // YYYY-MM-DD or week/month
  [category: string]: number;  // Alimenta√ß√£o: 150.50, etc.
}
```

### Category Selection [AC: 2]

**Top 5 by total amount:**

```typescript
function getTopCategories(transactions: Transaction[]): string[] {
  // Group expenses by category
  const categoryTotals = new Map<string, number>();
  transactions
    .filter(t => t.type === 'expense')
    .forEach(t => {
      const cat = t.category || 'Outros';
      categoryTotals.set(cat, (categoryTotals.get(cat) || 0) + t.amount);
    });

  // Sort by amount descending, take top 5
  return Array.from(categoryTotals.entries())
    .sort((a, b) => b[1] - a[1])
    .slice(0, 5)
    .map(([cat]) => cat);
}
```

**Others grouped as "Outros"**

### Time Granularity [AC: 3]

Based on date range:
- < 30 days ‚Üí Daily
- 30-90 days ‚Üí Weekly
- > 90 days ‚Üí Monthly

### Outlier Detection [AC: 7]

```typescript
function detectOutliers(data: TrendData[], category: string): Date[] {
  const values = data.map(d => d[category] || 0);
  const mean = values.reduce((a, b) => a + b, 0) / values.length;
  const variance = values.reduce((sum, v) => sum + Math.pow(v - mean, 2), 0) / values.length;
  const std = Math.sqrt(variance);
  const threshold = 2 * std;  // 2 standard deviations

  return data
    .filter(d => Math.abs((d[category] || 0) - mean) > threshold)
    .map(d => d.date);
}
```

### Component Structure

Location: `src/components/TrendsLineChart.tsx`

**Props:**
```typescript
interface TrendsLineChartProps {
  data: TrendData[];
  categories: string[];  // Top 5 + Outros
  timeGranularity: 'daily' | 'weekly' | 'monthly';
}
```

### Recharts Implementation

```tsx
<LineChart
  width={800}
  height={400}
  data={data}
  margin={{ top: 20, right: 30, left: 20, bottom: 5 }}
>
  <CartesianGrid strokeDasharray="3 3" stroke="#334155" />
  <XAxis
    dataKey="date"
    tickFormatter={formatDate}
    stroke="#64748b"
  />
  <YAxis
    tickFormatter={formatBRLShort}
    stroke="#64748b"
  />
  <Tooltip
    content={<CustomTooltip />}
    formatter={(value, name) => [formatBRL(value), name]}
  />
  <Legend
    onClick={(e) => handleLegendClick(e.dataKey)}
  />

  {/* Generate lines for each category */}
  {categories.map((cat, index) => (
    <Line
      key={cat}
      type="monotone"
      dataKey={cat}
      stroke={CATEGORY_COLORS[index]}
      strokeWidth={2}
      dot={false}
      connectNulls={false}
      hide={hiddenLines.has(cat)}
    />
  ))}

  {/* Outlier annotations */}
  {outliers.map(date => (
    <ReferenceLine
      key={date}
      x={date}
      stroke="#f43f5e"
      strokeWidth={1}
      strokeDasharray="3 3"
    />
  ))}
</LineChart>
```

### Smooth Curves [AC: 1]

Catmull-Rom interpolation (Recharts default with `type="monotone"`):

```tsx
<Line
  type="monotone"  // Catmull-Rom spline
  // ...
/>
```

### Crosshair Tooltip [AC: 5]

```tsx
<Tooltip
  content={({ active, payload }) => {
    if (!active || !payload) return null;

    return (
      <div className="bg-slate-800 border border-slate-700 rounded-lg p-3">
        <div className="text-sm text-slate-400 mb-2">
          {formatDate(payload[0].payload.date)}
        </div>
        {payload.map((entry, index) => (
          <div
            key={index}
            className="flex items-center gap-2 text-sm"
            style={{ color: entry.color }}
          >
            <span className="w-2 h-2 rounded-full bg-current" />
            <span>{entry.name}:</span>
            <span className="font-mono">{formatBRL(entry.value)}</span>
          </div>
        ))}
      </div>
    );
  }}
/>
```

### Legend Toggle [AC: 6]

```typescript
const [hiddenLines, setHiddenLines] = useState<Set<string>>(new Set());

const handleLegendClick = (category: string) => {
  setHiddenLines(prev => {
    const next = new Set(prev);
    if (next.has(category)) {
      next.delete(category);
    } else {
      next.add(category);
    }
    return next;
  });
};
```

### Gradient Fill [AC: 8]

Use `Area` with gradient:

```tsx
<defs>
  <linearGradient id={`gradient-${index}`} x1="0" y1="0" x2="0" y2="1">
    <stop offset="5%" stopColor={color} stopOpacity={0.3}/>
    <stop offset="95%" stopColor={color} stopOpacity={0}/>
  </linearGradient>
</defs>

<Area
  type="monotone"
  dataKey={cat}
  stroke={color}
  strokeWidth={2}
  fill={`url(#gradient-${index})`}
/>

{/* Then overlay Line for the stroke */}
<Line type="monotone" dataKey={cat} stroke={color} strokeWidth={2} dot={false} />
```

---

## Tasks / Subtasks

### Task 1: Create Data Transformation (AC: 2)

- Transform Transaction[] to TrendData[]
- Group by category and time
- Select top 5 categories
- Group rest as "Outros"

### Task 2: Determine Time Granularity (AC: 3)

- Calculate date range
- Select daily/weekly/monthly
- Format dates accordingly

### Task 3: Implement Outlier Detection (AC: 7)

- Calculate mean and std dev
- Identify outliers (>2std)
- Return outlier dates for annotation

### Task 4: Create Chart Component (AC: 1)

- Create `src/components/TrendsLineChart.tsx`
- Implement LineChart with smooth curves
- Configure colors for each category

### Task 5: Add Multiple Lines (AC: 2)

- Generate Line component for each category
- Use category colors from PRD
- Handle hidden lines

### Task 6: Implement Crosshair Tooltip (AC: 5)

- Create custom tooltip
- Show all visible lines
- Format as BRL

### Task 7: Add Legend Toggle (AC: 6)

- Implement legend with onClick
- Track hidden lines state
- Hide/show lines on toggle

### Task 8: Add Gradient Fill (AC: 8)

- Create gradient definitions
- Add Area components
- Overlay Line for stroke

### Task 9: Add Outlier Annotations (AC: 7)

- Add ReferenceLine for each outlier
- Style with dashed stroke
- Red color for visibility

### Task 10: Create Tests (Coverage)

- Test data transformation
- Test top category selection
- Test outlier detection
- Test chart rendering
- Test legend toggle

---

## Testing Strategy

### Unit Tests (Vitest)

- Top category selection
- Outlier detection algorithm
- Time granularity logic

### Visual Tests

- Multiple lines display
- Legend toggle works
- Gradient fill visible

### Manual Testing

1. Upload CSV with multiple months
2. Verify smooth curves
3. Check top 5 categories
4. Toggle lines in legend
5. Hover to see crosshair
6. Verify outliers marked

---

## Definition of Done

- [x] All acceptance criteria met
- [x] Smooth curves with Catmull-Rom
- [x] Top 5 categories + Outros
- [x] Timeline axis (daily/weekly/monthly)
- [x] Currency axis
- [x] Crosshair tooltip working
- [x] Legend toggle working
- [x] Outliers annotated
- [x] Gradient fill applied
- [x] Tests passing
- [x] CodeRabbit review passed

---

*Story created by AIOS Framework*
*Scrum Master: @sm (River)*
*Date: 2026-02-03*
