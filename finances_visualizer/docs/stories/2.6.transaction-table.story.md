# Story 2.6: Transaction Table with Filters

## Story Metadata

```yaml
epic: 2
story: 6
title: Transaction Table with Filters
status: Draft
created: 2026-02-03
estimated_days: 2
complexity: Medium

clickup:
  task_id: ""
  epic_task_id: ""
  list: "Backlog"
  url: ""
  last_sync: ""
```

---

## User Story

**As a** user,
**I want** to see and search through my individual transactions,
**so that** I can verify the data and find specific items.

---

## Acceptance Criteria

1. Table with columns: Date, Description, Category, Amount, Type
2. Sortable by all columns (click header)
3. Search input filters by description text (real-time)
4. Date range picker filters transactions
5. Pagination: 50 rows per page
6. Color coding: income = green text, expense = red text
7. Click row: highlights corresponding slice/bar on charts
8. Export table as CSV button

---

## Requirements Mapping

| AC | Functional Requirement | Notes |
|----|----------------------|-------|
| AC1 | FR12 | Table display |
| AC2 | FR7 | Sorting |
| AC3 | FR7 | Search |
| AC4 | FR7 | Date filter |
| AC5 | - | Pagination |
| AC6 | FR12 | Color coding |
| AC7 | FR5, FR7 | Cross-filtering |
| AC8 | FR8 | Export |

---

## ðŸ¤– CodeRabbit Integration

> **CodeRabbit Integration**: Enabled

### Story Type Analysis

- **Primary Type**: Frontend
- **Secondary Type(s)**: None
- **Complexity**: Medium (sorting, filtering, pagination)

### Specialized Agent Assignment

- **Primary Agents**: @dev (table + filters)
- **Supporting Agents**: None

### Quality Gate Tasks

- [ ] Pre-Commit (@dev): Run `coderabbit --prompt-only -t uncommitted` before marking story complete
- [ ] Pre-PR (@github-devops): Run `coderabbit --prompt-only --base main` before creating pull request

### CodeRabbit Focus Areas

**Primary Focus:**
- Table renders efficiently with large datasets (tested to 5k rows)
- Sort functionality works for all columns
- Real-time search doesn't cause performance issues
- Date range filtering accurate

**Secondary Focus:**
- Pagination works correctly
- Export CSV produces valid file
- Row click highlights chart elements

### Self-Healing Configuration

```
Expected Self-Healing:
  - Primary Agent: @dev (light mode)
  - Max Iterations: 2
  - Timeout: 15 minutes
  - Severity Filter: CRITICAL only
```

---

## Dev Notes

### Component Structure

Location: `src/components/TransactionTable.tsx`

**Props:**
```typescript
interface TransactionTableProps {
  transactions: Transaction[];
  filterCategory?: string;  // From chart click
  filterStartDate?: Date;
  filterEndDate?: Date;
  onRowClick?: (transaction: Transaction) => void;
}
```

### Table Columns [AC: 1]

| Column | Key | Type | Formatting |
|--------|-----|------|------------|
| Date | `date` | Date | DD/MM/YYYY |
| Description | `description` | String | Truncate if long |
| Category | `category` | String | Badge style |
| Amount | `amount` | Number | R$ X.XXX,XX |
| Type | `type` | String | Icon/badge |

### Sorting [AC: 2]

```typescript
const [sortConfig, setSortConfig] = useState<{
  key: keyof Transaction;
  direction: 'asc' | 'desc';
} | null>(null);

const sortedTransactions = useMemo(() => {
  if (!sortConfig) return transactions;

  return [...transactions].sort((a, b) => {
    const aVal = a[sortConfig.key];
    const bVal = b[sortConfig.key];

    if (aVal < bVal) return sortConfig.direction === 'asc' ? -1 : 1;
    if (aVal > bVal) return sortConfig.direction === 'asc' ? 1 : -1;
    return 0;
  });
}, [transactions, sortConfig]);

// Header click handler
const handleSort = (key: keyof Transaction) => {
  setSortConfig(prev => {
    if (prev?.key === key) {
      // Toggle direction
      return {
        key,
        direction: prev.direction === 'asc' ? 'desc' : 'asc'
      };
    }
    return { key, direction: 'asc' };
  });
};
```

### Search [AC: 3]

```typescript
const [searchTerm, setSearchTerm] = useState('');

const filteredTransactions = useMemo(() => {
  let result = transactions;

  // Search filter
  if (searchTerm) {
    result = result.filter(t =>
      t.description.toLowerCase().includes(searchTerm.toLowerCase())
    );
  }

  // Category filter (from chart click)
  if (filterCategory) {
    result = result.filter(t =>
      t.category === filterCategory || (t.category === null && filterCategory === 'Outros')
    );
  }

  // Date range filter
  if (filterStartDate || filterEndDate) {
    result = result.filter(t => {
      const date = new Date(t.date);
      if (filterStartDate && date < filterStartDate) return false;
      if (filterEndDate && date > filterEndDate) return false;
      return true;
    });
  }

  return result;
}, [transactions, searchTerm, filterCategory, filterStartDate, filterEndDate]);
```

### Date Range Picker [AC: 4]

Use existing component or build custom:

```tsx
<DateRangePicker
  startDate={filterStartDate}
  endDate={filterEndDate}
  onStartDateChange={setFilterStartDate}
  onEndDateChange={setFilterEndDate}
/>
```

Or use simple date inputs for MVP.

### Pagination [AC: 5]

```typescript
const [currentPage, setCurrentPage] = useState(1);
const ROWS_PER_PAGE = 50;

const paginatedTransactions = useMemo(() => {
  const start = (currentPage - 1) * ROWS_PER_PAGE;
  return filteredTransactions.slice(start, start + ROWS_PER_PAGE);
}, [filteredTransactions, currentPage]);

const totalPages = Math.ceil(filteredTransactions.length / ROWS_PER_PAGE);
```

### Color Coding [AC: 6]

```tsx
<Cell
  className={transaction.type === 'income' ? 'text-emerald-400' : 'text-rose-400'}
>
  {formatBRL(transaction.amount)}
</Cell>
```

### Row Click [AC: 7]

```tsx
<tr
  onClick={() => onRowClick?.(transaction)}
  className={`cursor-pointer transition-colors ${
    selectedTransaction?.id === transaction.id
      ? 'bg-purple-500/20'
      : 'hover:bg-slate-700/50'
  }`}
>
  {/* ... cells ... */}
</tr>
```

**Parent highlights chart:**

```tsx
<TransactionTable
  onRowClick={(transaction) => {
    setSelectedTransaction(transaction);
    // Could highlight chart element
    // Or filter to this transaction's category
  }}
/>
```

### Export CSV [AC: 8]

```typescript
function exportToCSV(transactions: Transaction[]) {
  // Convert to CSV string
  const headers = ['Data', 'DescriÃ§Ã£o', 'Categoria', 'Valor', 'Tipo'];
  const rows = transactions.map(t => [
    formatDate(t.date),
    t.description,
    t.category || '',
    t.amount.toFixed(2),
    t.type === 'income' ? 'receita' : 'despesa'
  ]);

  const csv = [
    headers.join(','),
    ...rows.map(row => row.join(','))
  ].join('\n');

  // Download
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `transactions-${formatDate(new Date())}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}
```

### Performance Considerations

- `useMemo` for filtered/sorted data
- Pagination limits DOM nodes (max 50 rows)
- Virtualization not needed for MVP (pagination sufficient)
- Search debounced if performance issues

---

## Tasks / Subtasks

### Task 1: Create Table Component (AC: 1)

- Create `src/components/TransactionTable.tsx`
- Define table structure
- Add columns: Date, Description, Category, Amount, Type

### Task 2: Implement Sorting (AC: 2)

- Add sort state
- Implement sort logic for each column
- Add header click handlers
- Show sort direction indicator

### Task 3: Add Search Input (AC: 3)

- Create search input field
- Implement real-time filtering
- Use useMemo for performance
- Debounce if needed

### Task 4: Add Date Range Filter (AC: 4)

- Add date inputs or picker
- Implement date range filtering
- Update filtered data on change

### Task 5: Implement Pagination (AC: 5)

- Add pagination controls
- Limit rows to 50 per page
- Add page numbers
- Add "Previous" / "Next" buttons

### Task 6: Add Color Coding (AC: 6)

- Style income amounts green
- Style expense amounts red
- Use Tailwind colors

### Task 7: Implement Row Click (AC: 7)

- Add onClick handler to rows
- Highlight selected row
- Call onRowClick callback

### Task 8: Add Export CSV (AC: 8)

- Create export button
- Implement CSV generation
- Trigger download

### Task 9: Create Tests (Coverage)

- Test sorting
- Test filtering (search, date, category)
- Test pagination
- Test export CSV
- Test with large dataset (5k rows)

---

## Testing Strategy

### Unit Tests (Vitest)

- Sorting algorithm
- Filtering logic
- Pagination calculations
- CSV export format

### Performance Tests

- 1,000 transactions: < 100ms render
- 5,000 transactions: < 500ms render
- Search response time

### Manual Testing

1. Upload CSV with many transactions
2. Test sorting on each column
3. Test search with various terms
4. Test date range filter
5. Navigate through pages
6. Click row â†’ verify highlight
7. Export and verify CSV

---

## Definition of Done

- [x] All acceptance criteria met
- [x] Table displays transactions
- [x] Sorting works for all columns
- [x] Search filters in real-time
- [x] Date range filtering works
- [x] Pagination: 50 rows per page
- [x] Color coding applied
- [x] Row click highlights
- [x] Export CSV working
- [x] Tests passing
- [x] CodeRabbit review passed

---

*Story created by AIOS Framework*
*Scrum Master: @sm (River)*
*Date: 2026-02-03*
