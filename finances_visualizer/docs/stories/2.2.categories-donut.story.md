# Story 2.2: Categories Donut Chart

## Story Metadata

```yaml
epic: 2
story: 2
title: Categories Donut Chart
status: Draft
created: 2026-02-03
estimated_days: 2
complexity: Medium

clickup:
  task_id: ""
  epic_task_id: ""
  list: "Backlog"
  url: ""
  last_sync: ""
```

---

## User Story

**As a** user,
**I want** to see a donut chart showing spending by category,
**so that** I can understand where my money goes.

---

## Acceptance Criteria

1. Donut chart using Recharts with 10 category colors
2. Center text: total expense value
3. Hover slice: highlights, shows tooltip (category, amount, %)
4. Click slice: filters transaction table below
5. Legend: color dots, category names, percentages
6. Animation: spins in on load, slices fade in sequentially
7. Handles "Outros" category (gray, always last)
8. Export button appears on hover (PNG/PDF)

---

## Requirements Mapping

| AC | Functional Requirement | Notes |
|----|----------------------|-------|
| AC1 | FR5 | Donut chart |
| AC2 | FR12 | Center text |
| AC3 | FR5, FR7 | Interactivity |
| AC4 | FR5, FR7 | Click to filter |
| AC5 | FR5 | Legend |
| AC6 | UI Design Goals | Animation |
| AC7 | FR4 | Outros handling |
| AC8 | FR8 | Export |

---

## ðŸ¤– CodeRabbit Integration

> **CodeRabbit Integration**: Enabled

### Story Type Analysis

- **Primary Type**: Frontend
- **Secondary Type(s)**: None
- **Complexity**: Medium (Recharts, interactivity)

### Specialized Agent Assignment

- **Primary Agents**: @dev (chart component)
- **Supporting Agents**: None

### Quality Gate Tasks

- [ ] Pre-Commit (@dev): Run `coderabbit --prompt-only -t uncommitted` before marking story complete
- [ ] Pre-PR (@github-devops): Run `coderabbit --prompt-only --base main` before creating pull request

### CodeRabbit Focus Areas

**Primary Focus:**
- Recharts PieChart configured correctly with donut variant
- Colors match PRD scheme (10 categories + Outros gray)
- Tooltip shows correct data (category, amount, percentage)
- Click interaction properly filters transaction table

**Secondary Focus:**
- Legend properly renders all categories
- Animation doesn't cause performance issues
- "Outros" always positioned last

### Self-Healing Configuration

```
Expected Self-Healing:
  - Primary Agent: @dev (light mode)
  - Max Iterations: 2
  - Timeout: 15 minutes
  - Severity Filter: CRITICAL only
```

---

## Dev Notes

### Chart Library [Source: PRD Technical Assumptions]

**Recharts** - React-native charting library

Install: `npm install recharts`

### Data Structure [Source: Story 1.5]

```typescript
// Input: CategorySummary[] from aggregation
interface CategorySummary {
  category: string;
  amount: number;
  percentage: number;
  transactionCount: number;
}
```

### Color Palette [Source: PRD Branding]

```typescript
const CATEGORY_COLORS = [
  '#f43f5e',  // AlimentaÃ§Ã£o (Rose)
  '#3b82f6',  // Transporte (Blue)
  '#8b5cf6',  // Moradia (Purple)
  '#ec4899',  // Lazer (Pink)
  '#14b8a6',  // SaÃºde (Teal)
  '#f59e0b',  // EducaÃ§Ã£o (Amber)
  '#06b6d4',  // Compras (Cyan)
  '#6366f1',  // ServiÃ§os (Indigo)
  '#84cc16',  // TransferÃªncias (Lime)
  '#94a3b8',  // Outros (Slate gray) - always last
];
```

### Component Structure

Location: `src/components/CategoriesDonutChart.tsx`

**Props:**
```typescript
interface CategoriesDonutChartProps {
  data: CategorySummary[];
  totalExpense: number;
  onCategoryClick?: (category: string) => void;
  onExport?: () => void;
}
```

### Recharts Implementation

```tsx
<PieChart width={400} height={400}>
  <Pie
    data={data}
    cx="50%"
    cy="50%"
    labelLine={false}
    label={false}  // No labels on slices
    outerRadius={120}
    innerRadius={80}  // Donut!
    paddingAngle={2}
    dataKey="amount"
  >
    {data.map((entry, index) => (
      <Cell
        key={entry.category}
        fill={CATEGORY_COLORS[index]}
        stroke={darkBg}
        strokeWidth={2}
      />
    ))}
  </Pie>
  <Tooltip
    content={<CustomTooltip />}
    formatter={(value: number) => formatBRL(value)}
  />
</PieChart>
```

### Center Text

Overlay text in donut center:

```tsx
<div style={{
  position: 'absolute',
  top: '50%',
  left: '50%',
  transform: 'translate(-50%, -50%)',
  textAlign: 'center'
}}>
  <div style={{ fontSize: '14px', opacity: 0.7 }}>Total</div>
  <div style={{ fontSize: '24px', fontWeight: 'bold' }}>
    {formatBRL(totalExpense)}
  </div>
</div>
```

### Click Interaction [AC: 4]

```tsx
const handleClick = (data: any, index: number) => {
  const category = chartData[index].category;
  onCategoryClick?.(category);  // Notify parent
};

<Pie onClick={handleClick}>
  {/* ... */}
</Pie>
```

Parent component filters transaction table:

```tsx
const [selectedCategory, setSelectedCategory] = useState<string | null>();

<CategoriesDonutChart
  onCategoryClick={setSelectedCategory}
/>

<TransactionTable
  filterCategory={selectedCategory}
/>
```

### Animation [AC: 6]

Use Recharts built-in animation:

```tsx
<Pie
  isAnimationActive={true}
  animationBegin={0}
  animationDuration={800}
  animationEasing="ease-out"
>
```

For sequential slice fade-in, use Framer Motion wrapper or delay each Cell.

### Legend [AC: 5]

```tsx
<Legend
  verticalAlign="bottom"
  height={36}
  content={({ payload }) => (
    <ul className="flex flex-wrap justify-center gap-4">
      {payload.map((entry, index) => (
        <li key={index} className="flex items-center gap-2">
          <span
            className="w-3 h-3 rounded-full"
            style={{ backgroundColor: entry.color }}
          />
          <span>{entry.value}</span>
          <span className="opacity-70">
            {entry.payload?.percentage.toFixed(1)}%
          </span>
        </li>
      ))}
    </ul>
  )}
/>
```

### "Outros" Handling [AC: 7]

```typescript
// Ensure "Outros" is always last
const sortedData = [
  ...data.filter(d => d.category !== 'Outros'),
  data.find(d => d.category === 'Outros') || {
    category: 'Outros',
    amount: 0,
    percentage: 0,
    transactionCount: 0
  }
].filter(d => d.amount > 0);
```

### Export Button [AC: 8]

Location: `src/components/ChartExportButton.tsx`

```tsx
<div className="group relative">
  <PieChart>
    {/* ... */}
  </PieChart>

  {/* Export button - appears on hover */}
  <button
    className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity"
    onClick={onExport}
  >
    <DownloadIcon />
  </button>
</div>
```

---

## Tasks / Subtasks

### Task 1: Install Recharts (Setup)

- Run `npm install recharts`
- Verify installation

### Task 2: Create Color Palette (AC: 1)

- Define CATEGORY_COLORS array
- Map categories to colors
- Ensure "Outros" is gray

### Task 3: Create Donut Chart Component (AC: 1, 2, 7)

- Create `src/components/CategoriesDonutChart.tsx`
- Implement PieChart with donut (innerRadius)
- Add center text with total expense
- Handle "Outros" always last

### Task 4: Add Tooltip (AC: 3)

- Create custom tooltip component
- Show category, amount (BRL), percentage
- Style with dark theme

### Task 5: Implement Click Interaction (AC: 4)

- Add onClick handler to Pie slices
- Call onCategoryClick callback
- Highlight selected slice

### Task 6: Create Legend (AC: 5)

- Implement custom legend
- Show color dot, category name, percentage
- Responsive layout

### Task 7: Add Animation (AC: 6)

- Configure Recharts animation
- Spin-in effect on load
- Sequential slice fade-in

### Task 8: Add Export Button (AC: 8)

- Create export button component
- Show on chart hover
- Wire up to export function (Story 3.2)

### Task 9: Create Tests (Coverage)

- Test chart rendering with sample data
- Test click interaction
- Test tooltip display
- Test "Outros" positioning
- Test export button visibility

---

## Testing Strategy

### Unit Tests (Vitest)

- Component renders with data
- Click interaction fires callback
- "Outros" positioned last
- Colors assigned correctly

### Visual Tests

- Chart renders correctly
- Legend displays all categories
- Tooltip shows correct info

### Manual Testing

1. Upload CSV with categorized transactions
2. Verify donut chart displays
3. Hover slices â†’ tooltip appears
4. Click slice â†’ table filters
5. Check "Outros" is gray and last
6. Test export button

---

## Definition of Done

- [x] All acceptance criteria met
- [x] Donut chart displays category data
- [x] Center text shows total expense
- [x] Hover shows tooltip
- [x] Click filters transaction table
- [x] Legend displays all categories
- [x] Animation smooth
- [x] "Outros" handled correctly
- [x] Export button working
- [x] Tests passing
- [x] CodeRabbit review passed

---

*Story created by AIOS Framework*
*Scrum Master: @sm (River)*
*Date: 2026-02-03*
