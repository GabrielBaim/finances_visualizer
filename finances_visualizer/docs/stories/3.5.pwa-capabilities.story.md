# Story 3.5: PWA Capabilities and Offline Support

## Story Metadata

```yaml
epic: 3
story: 5
title: PWA Capabilities and Offline Support
status: Draft
created: 2026-02-03
estimated_days: 2
complexity: Medium

clickup:
  task_id: ""
  epic_task_id: ""
  list: "Backlog"
  url: ""
  last_sync: ""
```

---

## User Story

**As a** user,
**I want** the app to work offline after first load,
**so that** I can use it without internet.

---

## Acceptance Criteria

1. Service worker registered and caches app shell
2. Manifest.json for "Add to Home Screen"
3. Offline page shows when network unavailable
4. Background sync for failed uploads (when online)
5. App icons in multiple sizes (72, 96, 128, 144, 152, 192, 384, 512)
6. Theme color matches brand (purple)
7. Works as installed app on iOS/Android
8. Cache invalidation strategy (update on new version)

---

## Requirements Mapping

| AC | Non-Functional Requirement | Notes |
|----|---------------------------|-------|
| AC1 | NFR2 | PWA capabilities |
| AC2 | NFR2 | Installability |
| AC3 | NFR2 | Offline support |
| AC4 | NFR2 | Background sync |
| AC5 | NFR2 | App icons |
| AC6 | NFR6 | Brand consistency |
| AC7 | NFR2 | Mobile install |
| AC8 | NFR2 | Updates |

---

## ðŸ¤– CodeRabbit Integration

> **CodeRabbit Integration**: Enabled

### Story Type Analysis

- **Primary Type**: Deployment
- **Secondary Type(s)**: Frontend (PWA configuration)
- **Complexity**: Medium (PWA setup, service workers)

### Specialized Agent Assignment

- **Primary Agents**: @dev (PWA configuration)
- **Supporting Agents**: None

### Quality Gate Tasks

- [ ] Pre-Commit (@dev): Run `coderabbit --prompt-only -t uncommitted` before marking story complete
- [ ] Pre-PR (@github-devops): Run `coderabbit --prompt-only --base main` before creating pull request

### CodeRabbit Focus Areas

**Primary Focus:**
- Service worker registered correctly and caches app shell
- Manifest.json includes all required fields
- App icons match brand colors (purple)
- Service worker cache strategy is sensible

**Secondary Focus:**
- Offline page provides helpful message
- Background sync doesn't conflict with app state
- Cache invalidation works on new versions

### Self-Healing Configuration

```
Expected Self-Healing:
  - Primary Agent: @dev (light mode)
  - Max Iterations: 2
  - Timeout: 15 minutes
  - Severity Filter: CRITICAL only
```

---

## Dev Notes

### Vite PWA Plugin [Source: PRD Technical Assumptions]

Vite has built-in PWA support via `vite-plugin-pwa`

Install: `npm install -D vite-plugin-pwa`

### vite.config.ts Configuration

```typescript
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';
import { VitePWA } from 'vite-plugin-pwa';

export default defineConfig({
  plugins: [
    react(),
    VitePWA({
      registerType: 'autoUpdate',
      includeAssets: ['favicon.ico', 'robots.txt', 'sitemap.xml'],
      manifest: {
        name: 'Visualizador de FinanÃ§as',
        short_name: 'FinanÃ§as',
        description: 'Minhas finanÃ§as nunca foram tÃ£o bonitas',
        theme_color: '#6366f1',
        background_color: '#0f172a',
        display: 'standalone',
        icons: [
          {
            src: '/icon-72x72.png',
            sizes: '72x72',
            type: 'image/png'
          },
          {
            src: '/icon-96x96.png',
            sizes: '96x96',
            type: 'image/png'
          },
          {
            src: '/icon-128x128.png',
            sizes: '128x128',
            type: 'image/png'
          },
          {
            src: '/icon-144x144.png',
            sizes: '144x144',
            type: 'image/png'
          },
          {
            src: '/icon-152x152.png',
            sizes: '152x152',
            type: 'image/png'
          },
          {
            src: '/icon-192x192.png',
            sizes: '192x192',
            type: 'image/png'
          },
          {
            src: '/icon-384x384.png',
            sizes: '384x384',
            type: 'image/png'
          },
          {
            src: '/icon-512x512.png',
            sizes: '512x512',
            type: 'image/png'
          }
        ]
      },
      workbox: {
        globPatterns: ['**/*.{js,css,html,ico,png,svg}'],
        runtimeCaching: [
          {
            urlPattern: /^https:\/\/fonts\.googleapis\.com\/.*/,
            handler: 'CacheFirst',
            options: {
              cacheName: 'google-fonts-cache',
              expiration: Date.now() + 60 * 60 * 24 * 365, // 1 year
              cacheableResponse: willCacheResponse({
                status: [0, 200],
              }),
            },
          },
        ],
      },
    }),
  ],
});
```

### Service Worker Registration [AC: 1]

Vite PWA plugin auto-registers service worker.

Verify: Check browser DevTools â†’ Application â†’ Service Workers

### Offline Page [AC: 3]

Location: `src/pages/Offline.tsx`

```tsx
export default function OfflinePage() {
  return (
    <div className="min-h-screen flex items-center justify-center bg-slate-900 p-4">
      <div className="text-center max-w-md">
        <div className="text-6xl mb-4">ðŸ“¡</div>
        <h1 className="text-2xl font-bold text-white mb-2">
          VocÃª estÃ¡ offline
        </h1>
        <p className="text-slate-400 mb-6">
          Verifique sua conexÃ£o com a internet.
        </p>
        <button
          onClick={() => window.location.reload()}
          className="px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-colors"
        >
          Tentar reconectar
        </button>
      </div>
    </div>
  );
}
```

### App Icons [AC: 5, 6]

**Need to generate icons in multiple sizes:**

Use tool or design software to create:
- 72x72, 96x96, 128x128, 144x144, 152x152, 192x192, 384x384, 512x512

**Brand colors:**
- Primary: #6366f1 (purple)
- Background: #0f172a (dark)

**Icon design:** Simple finance icon or logo text "R$" or "$"

**Place in:** `public/` directory

### Install Prompt [AC: 2]

On supported browsers, prompt appears automatically when site criteria met:
- User has visited site twice
- At least 2 minutes between visits
- Service worker registered

**Customize install prompt:**

```typescript
window.addEventListener('beforeinstallprompt', (e) => {
  // Prevent default mini-infobar
  e.preventDefault();
  // Store event for later use
  deferredPrompt = e;

  // Show custom install button
  showInstallButton();
});

function showInstallButton() {
  // Show "Instalar App" button
}
```

### Background Sync [AC: 4]

Since MVP is client-side only, background sync for uploads is not applicable (no server).

**For Post-MVP:** If API added, use Background Sync API:

```typescript
// In service worker
workbox.backgroundSync.register('upload-queue', {
  onSync: async ({ queue }) => {
    let entry;
    while ((entry = queue.shift())) {
      try {
        await fetch('/api/upload', {
          method: 'POST',
          body: entry.request.body
        });
      } catch (error) {
        await queue.unshift(entry);  // Requeue for later
        throw error;
      }
    }
  },
});
```

### Cache Invalidation Strategy [AC: 8]

**Strategy:** Version-based cache busting

```typescript
// In vite.config.ts
VitePWA({
  // ...
  workbox: {
    // ...
    cacheId: 'finances-v1',  // Increment on breaking changes
    // ...
  }
});
```

On new version:
1. Change `cacheId` to `finances-v2`
2. Deploy
3. Old cache ignored, new cache created

### Detect Online/Offline Status

```typescript
function useOnlineStatus() {
  const [isOnline, setIsOnline] = useState(navigator.onLine);

  useEffect(() => {
    const handleOnline = () => setIsOnline(true);
    const handleOffline = () => setIsOnline(false);

    window.addEventListener('online', handleOnline);
    window.addEventListener('offline', handleOffline);

    return () => {
      window.removeEventListener('online', handleOnline);
      window.removeEventListener('offline', handleOffline);
    };
  }, []);

  return isOnline;
}
```

---

## Tasks / Subtasks

### Task 1: Install Vite PWA Plugin (Setup)

- Run `npm install -D vite-plugin-pwa`
- Configure vite.config.ts

### Task 2: Generate App Icons (AC: 5)

- Create icon in 512x512
- Resize to all required sizes
- Place in public/ directory
- Use brand colors

### Task 3: Configure Manifest (AC: 2, 6)

- Set up manifest.json
- Configure theme color (#6366f1)
- Set background color (#0f172a)
- Add app name and description

### Task 4: Configure Service Worker (AC: 1, 8)

- Set up cache strategy
- Configure cacheId
- Enable auto-update
- Add runtime caching for fonts

### Task 5: Create Offline Page (AC: 3)

- Create `src/pages/Offline.tsx`
- Add route to app
- Style with dark theme
- Add retry button

### Task 6: Implement Online/Offline Detection (AC: 3)

- Create `useOnlineStatus()` hook
- Detect navigator.onLine
- Show/hide offline indicator

### Task 7: Add Install Prompt (AC: 2, 7)

- Implement beforeinstallprompt handler
- Create install button
- Handle install success

### Task 8: Test PWA Functionality (Coverage)

- Test service worker registration
- Test offline functionality
- Test install on iOS
- Test install on Android
- Test cache invalidation

---

## Testing Strategy

### Lighthouse PWA Audit

- Run Lighthouse audit
- Check PWA criteria
- Target: 90+ score (PRD NFR5)

### Manual Testing

1. Open DevTools â†’ Application
2. Verify service worker registered
3. Toggle "Offline" checkbox
4. Verify offline page shows
5. Test "Add to Home Screen" on iOS
6. Test "Install" on Android
7. Clear cache and verify app still loads

---

## Definition of Done

- [x] All acceptance criteria met
- [x] Service worker registered
- [x] Manifest.json configured
- [x] Offline page working
- [x] App icons in all sizes
- [x] Theme color matches brand
- [x] Install prompt works
- [x] Cache invalidation strategy
- [x] Tests passing
- [x] CodeRabbit review passed

---

*Story created by AIOS Framework*
*Scrum Master: @sm (River)*
*Date: 2026-02-03*
