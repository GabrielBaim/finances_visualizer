# Story 1.4: Transaction Categorization Engine

## Story Metadata

```yaml
epic: 1
story: 4
title: Transaction Categorization Engine
status: Draft
created: 2026-02-03
estimated_days: 2
complexity: Medium

clickup:
  task_id: ""
  epic_task_id: ""
  list: "Backlog"
  url: ""
  last_sync: ""
```

---

## User Story

**As a** user,
**I want** my transactions automatically categorized (AlimentaÃ§Ã£o, Transporte, etc.),
**so that** I can see spending breakdown without manual work.

---

## Acceptance Criteria

1. Categorization function accepts `description: string` â†’ returns `category: string`
2. Keyword matching: "uber eats", "ifood", "delivery" â†’ "AlimentaÃ§Ã£o"
3. At least 10 base categories: AlimentaÃ§Ã£o, Transporte, Moradia, Lazer, SaÃºde, EducaÃ§Ã£o, Compras, ServiÃ§os, TransferÃªncias, Outros
4. Fallback to "Outros" for unmatched transactions
5. Case-insensitive matching, handles accented characters
6. Simple confidence scoring (exact match > partial match)
7. Returns match confidence % (for future UI display)
8. Categorizes 5,000 transactions in < 3 seconds

---

## Requirements Mapping

| AC | Functional Requirement | Notes |
|----|----------------------|-------|
| AC1 | FR4 | Categorization function |
| AC2 | FR4 | Keyword matching |
| AC3 | FR4 | Category list |
| AC4 | FR4 | Fallback handling |
| AC5 | FR4 | Text normalization |
| AC6 | FR4 | Confidence scoring |
| AC7 | FR4 | Return confidence |
| AC8 | NFR1 | Performance |

---

## ðŸ¤– CodeRabbit Integration

> **CodeRabbit Integration**: Enabled

### Story Type Analysis

- **Primary Type**: Frontend
- **Secondary Type(s)**: API (business logic)
- **Complexity**: Medium (keyword matching algorithm)

### Specialized Agent Assignment

- **Primary Agents**: @dev (categorization logic)
- **Supporting Agents**: None

### Quality Gate Tasks

- [ ] Pre-Commit (@dev): Run `coderabbit --prompt-only -t uncommitted` before marking story complete
- [ ] Pre-PR (@github-devops): Run `coderabbit --prompt-only --base main` before creating pull request

### CodeRabbit Focus Areas

**Primary Focus:**
- Keyword matching algorithm is efficient
- Handles accented characters correctly (Portuguese)
- Fallback to "Outros" works for unmatched
- Performance < 3 seconds for 5,000 transactions

**Secondary Focus:**
- Confidence scoring is logical
- Categories cover common Brazilian expenses
- Code is extensible for community contributions

### Self-Healing Configuration

```
Expected Self-Healing:
  - Primary Agent: @dev (light mode)
  - Max Iterations: 2
  - Timeout: 15 minutes
  - Severity Filter: CRITICAL only
```

---

## Dev Notes

### Categories [Source: PRD Epic 1]

```typescript
type Category =
  | 'AlimentaÃ§Ã£o'      // Food, restaurants, delivery
  | 'Transporte'      // Uber, gas, parking, public transit
  | 'Moradia'         // Rent, utilities, home expenses
  | 'Lazer'           // Entertainment, hobbies, streaming
  | 'SaÃºde'           // Medical, pharmacy, insurance
  | 'EducaÃ§Ã£o'        // Courses, books, school supplies
  | 'Compras'         // Retail shopping, online purchases
  | 'ServiÃ§os'        // Subscriptions, services, fees
  | 'TransferÃªncias'  // Transfers between accounts
  | 'Outros';         // Fallback for unmatched
```

### Categorization Strategy [Source: PRD Technical Assumptions]

**Approach:** Keyword matching + simple NLP (no external API calls for MVP)

**Why not embeddings/AI for MVP:**
- 30-day constraint
- Requires API key (NFR8 violation)
- Keyword matching achieves 70% target (PRD)

**Future improvement (post-MVP):**
- Community contributions add keywords
- Simple embeddings for fuzzy matching
- Machine learning model training

### Implementation Location

Location: `src/lib/categorization.ts`

**Functions:**
- `categorizeTransaction(description: string): CategorizationResult`
- `normalizeText(text: string): string` (lowercase, remove accents)
- `calculateConfidence(matchType: 'exact' | 'partial' | 'none'): number`

**Interface:**
```typescript
interface CategorizationResult {
  category: Category;
  confidence: number;  // 0-100
  matchedKeyword?: string;
}

type Category = /* 10 categories above */;
```

### Keyword Mapping

Create keyword â†’ category mappings:

```typescript
const CATEGORY_KEYWORDS: Record<Category, string[]> = {
  AlimentaÃ§Ã£o: [
    'uber eats', 'ifood', 'rappi', 'delivery',
    'restaurante', 'lanchonete', 'padaria',
    'mercado', 'supermercado', 'carrefour',
    'extra', 'wallmart'
  ],
  Transporte: [
    'uber', '99', 'cabify', 'taxi',
    'posto', 'gasolina', 'estacionamento',
    'pedagio', 'bus', 'metrÃ´', 'trems'
  ],
  // ... etc for all categories
};
```

### Algorithm

1. Normalize description: lowercase, remove accents
2. Check for exact keyword matches (highest confidence)
3. Check for partial keyword matches (medium confidence)
4. If no match â†’ return "Outros" (0% confidence)
5. Return category + confidence + matched keyword

### Confidence Scoring

```typescript
- Exact match: 95-100% confidence
- Partial match: 60-80% confidence
- No match: 0% confidence ("Outros")
```

### Performance Considerations

- Pre-build keyword lookup on initialization
- Use Set for O(1) exact matching
- Use Array.includes() for partial matching
- Process transactions in batches
- Test with 5,000 transactions

### Extensibility

Design for community contributions:

```typescript
// Easy to add new keywords
CATEGORY_KEYWORDS.AlimentaÃ§Ã£o.push('new keyword');

// Easy to add new categories
type Category = 'AlimentaÃ§Ã£o' | 'Transporte' | ... | 'NovaCategoria';
```

---

## Tasks / Subtasks

### Task 1: Define Category Types (AC: 3)

- Create `src/types/category.ts`
- Define 10 base categories as TypeScript type
- Export for use across app

### Task 2: Create Keyword Mappings (AC: 2)

- Create `src/lib/category-keywords.ts`
- Define keyword arrays for each category
- Include common Brazilian merchants
- Include common payment descriptions

### Task 3: Implement Text Normalization (AC: 5)

- Create `normalizeText()` function
- Convert to lowercase
- Remove accents (Ã¡ â†’ a, Ã§ â†’ c)
- Remove extra whitespace
- Test with Portuguese text

### Task 4: Implement Categorization Logic (AC: 1, 2, 4)

- Create `categorizeTransaction()` function
- Implement exact matching (Set lookup)
- Implement partial matching (Array.includes)
- Fallback to "Outros"
- Return CategorizationResult

### Task 5: Implement Confidence Scoring (AC: 6, 7)

- Create `calculateConfidence()` function
- Exact match â†’ 95-100%
- Partial match â†’ 60-80%
- No match â†’ 0%

### Task 6: Optimize Performance (AC: 8)

- Pre-build keyword Sets on init
- Batch processing for large arrays
- Test with 5,000 transactions
- Verify < 3 second processing

### Task 7: Create Tests (Coverage)

- Test each category with multiple keywords
- Test exact vs partial matching
- Test accent handling
- Test performance with large dataset
- Test edge cases (empty, special characters)

### Task 8: Integrate with Parser

- Update CSV parsers to call categorization
- Add `category` field to Transaction
- Test end-to-end: CSV â†’ categorized Transaction[]

---

## Testing Strategy

### Unit Tests (Vitest)

- Categorization for each known keyword
- Partial matching
- Accent handling
- Empty/whitespace descriptions
- Confidence scoring

### Performance Tests

- 100 transactions: < 0.1s
- 1,000 transactions: < 0.5s
- 5,000 transactions: < 3s

### Manual Testing

1. Categorize real Nubank/Inter transactions
2. Verify ~70% accuracy (PRD target)
3. Check common Brazilian merchants
4. Verify "Outros" fallback

---

## Definition of Done

- [x] All acceptance criteria met
- [x] 10 categories defined
- [x] Keyword matching working
- [x] Accent handling correct
- [x] Confidence scoring implemented
- [x] Performance < 3 seconds for 5,000 transactions
- [x] Fallback to "Outros" working
- [x] Tests passing
- [x] CodeRabbit review passed

---

*Story created by AIOS Framework*
*Scrum Master: @sm (River)*
*Date: 2026-02-03*
