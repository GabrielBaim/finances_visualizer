# Story 2.5: Balance Area Chart

## Story Metadata

```yaml
epic: 2
story: 5
title: Balance Area Chart
status: Draft
created: 2026-02-03
estimated_days: 1.5
complexity: Low

clickup:
  task_id: ""
  epic_task_id: ""
  list: "Backlog"
  url: ""
  last_sync: ""
```

---

## User Story

**As a** user,
**I want** to see my accumulated balance over time as an area chart,
**so that** I can visualize my financial trajectory.

---

## Acceptance Criteria

1. Area chart showing cumulative balance (starting from first transaction)
2. Gradient fill (purple, semi-transparent)
3. X-axis: Timeline
4. Y-axis: Balance values (can be negative)
5. Zero line highlighted (when balance crosses)
6. Hover: tooltip with date and balance
7. Color coding: green when positive, red when negative
8. Animation: draws left-to-right

---

## Requirements Mapping

| AC | Functional Requirement | Notes |
|----|----------------------|-------|
| AC1 | FR5 | Area chart |
| AC2 | UI Design Goals | Gradient fill |
| AC3 | FR5 | Timeline |
| AC4 | FR5 | Balance values |
| AC5 | FR5 | Zero line |
| AC6 | FR5, FR7 | Tooltip |
| AC7 | FR5 | Color coding |
| AC8 | UI Design Goals | Animation |

---

## ðŸ¤– CodeRabbit Integration

> **CodeRabbit Integration**: Enabled

### Story Type Analysis

- **Primary Type**: Frontend
- **Secondary Type(s)**: None
- **Complexity**: Low (single line, area chart)

### Specialized Agent Assignment

- **Primary Agents**: @dev (chart component)
- **Supporting Agents**: None

### Quality Gate Tasks

- [ ] Pre-Commit (@dev): Run `coderabbit --prompt-only -t uncommitted` before marking story complete
- [ ] Pre-PR (@github-devops): Run `coderabbit --prompt-only --base main` before creating pull request

### CodeRabbit Focus Areas

**Primary Focus:**
- Recharts AreaChart configured correctly
- Cumulative balance calculation accurate
- Gradient fill matches PRD purple
- Zero line clearly visible

**Secondary Focus:**
- Animation draws smoothly left-to-right
- Tooltip shows accurate date and balance
- Color changes at zero crossing

### Self-Healing Configuration

```
Expected Self-Healing:
  - Primary Agent: @dev (light mode)
  - Max Iterations: 2
  - Timeout: 15 minutes
  - Severity Filter: CRITICAL only
```

---

## Dev Notes

### Data Preparation [Source: Story 1.5]

Calculate cumulative balance over time:

```typescript
interface BalanceData {
  date: Date;
  balance: number;
}

function calculateCumulativeBalance(transactions: Transaction[]): BalanceData[] {
  // Sort by date
  const sorted = [...transactions].sort((a, b) =>
    new Date(a.date).getTime() - new Date(b.date).getTime()
  );

  // Calculate running balance
  let balance = 0;
  const result: BalanceData[] = [];

  sorted.forEach(t => {
    if (t.type === 'income') {
      balance += t.amount;
    } else {
      balance -= t.amount;
    }
    result.push({
      date: new Date(t.date),
      balance
    });
  });

  return result;
}
```

### Component Structure

Location: `src/components/BalanceAreaChart.tsx`

**Props:**
```typescript
interface BalanceAreaChartProps {
  data: BalanceData[];
}
```

### Recharts Implementation

```tsx
<AreaChart
  width={800}
  height={400}
  data={data}
  margin={{ top: 20, right: 30, left: 20, bottom: 5 }}
>
  <defs>
    <linearGradient id="balanceGradient" x1="0" y1="0" x2="0" y2="1">
      <stop offset="5%" stopColor="#6366f1" stopOpacity={0.5}/>
      <stop offset="95%" stopColor="#6366f1" stopOpacity={0.05}/>
    </linearGradient>
  </defs>

  <CartesianGrid strokeDasharray="3 3" stroke="#334155" />
  <XAxis
    dataKey="date"
    tickFormatter={formatDate}
    stroke="#64748b"
  />
  <YAxis
    tickFormatter={formatBRLShort}
    stroke="#64748b"
  />

  {/* Zero line reference */}
  <ReferenceLine
    y={0}
    stroke="#94a3b8"
    strokeWidth={2}
    strokeDasharray="5 5"
  />

  <Tooltip
    content={<CustomTooltip />}
    formatter={(value: number) => formatBRL(value)}
    labelFormatter={(date) => formatDate(date)}
  />

  <Area
    type="monotone"
    dataKey="balance"
    stroke="#6366f1"
    strokeWidth={2}
    fill="url(#balanceGradient)"
    isAnimationActive={true}
    animationBegin={400}
    animationDuration={800}
  />
</AreaChart>
```

### Zero Line [AC: 5]

ReferenceLine at y=0:
- Dashed stroke
- Visible when chart spans positive and negative
- Helps user see when balance crosses zero

### Color Coding [AC: 7]

**Advanced:** Change color based on balance value:

```tsx
// This requires splitting the area into two parts
// For MVP, single purple area is acceptable

// Post-MVP: Use two areas with different gradients
// - Positive balance: Green gradient
// - Negative balance: Red gradient
```

### Animation [AC: 8]

```tsx
<Area
  isAnimationActive={true}
  animationBegin={400}  // After previous charts
  animationDuration={800}
  animationEasing="ease-out"
/>
```

Draws from left to right over 800ms.

---

## Tasks / Subtasks

### Task 1: Create Balance Calculation (AC: 1)

- Create `calculateCumulativeBalance()` function
- Sort transactions by date
- Calculate running balance
- Return BalanceData[]

### Task 2: Create Chart Component (AC: 1, 2)

- Create `src/components/BalanceAreaChart.tsx`
- Implement AreaChart
- Add gradient definition
- Configure purple gradient

### Task 3: Add Zero Line (AC: 5)

- Add ReferenceLine at y=0
- Style with dashed stroke
- Make visible when chart crosses zero

### Task 4: Configure Axes (AC: 3, 4)

- Add XAxis with date formatter
- Add YAxis with currency formatter
- Style with dark theme

### Task 5: Add Tooltip (AC: 6)

- Create custom tooltip
- Show date and balance
- Format as BRL

### Task 6: Add Animation (AC: 8)

- Configure area animation
- Draw left-to-right
- Stagger after previous charts

### Task 7: Create Tests (Coverage)

- Test cumulative balance calculation
- Test chart rendering
- Test with positive balances only
- Test with negative balances
- Test zero crossing

---

## Testing Strategy

### Unit Tests (Vitest)

- Cumulative balance calculation
- Sorting by date
- Running balance logic

### Visual Tests

- Area chart displays
- Gradient visible
- Zero line shows

### Manual Testing

1. Upload CSV with positive balance
2. Upload CSV with negative balance
3. Upload CSV crossing zero
4. Verify gradient fill
5. Check animation smooth

---

## Definition of Done

- [x] All acceptance criteria met
- [x] Cumulative balance calculated correctly
- [x] Area chart displays
- [x] Purple gradient fill
- [x] Timeline axis
- [x] Currency axis
- [x] Zero line visible
- [x] Tooltip working
- [x] Animation draws left-to-right
- [x] Tests passing
- [x] CodeRabbit review passed

---

*Story created by AIOS Framework*
*Scrum Master: @sm (River)*
*Date: 2026-02-03*
