# Story 3.3: Shareable Dashboard Links

## Story Metadata

```yaml
epic: 3
story: 3
title: Shareable Dashboard Links
status: Draft
created: 2026-02-03
estimated_days: 3
complexity: High

clickup:
  task_id: ""
  epic_task_id: ""
  list: "Backlog"
  url: ""
  last_sync: ""
```

---

## User Story

**As a** user,
**I want** to generate a temporary link to share my dashboard,
**so that** others can view my visualizations.

---

## Acceptance Criteria

1. "Share" button generates unique URL
2. Link expires after 24 hours (shows countdown)
3. Share view is read-only (no filters, no export)
4. Share view shows "Create your own" CTA
5. URL is short and readable (e.g., `/share/abc123`)
6. Copy to clipboard button with success feedback
7. Shows preview image on social media (Open Graph tags)
8. Rate limit: max 5 share links per hour per IP

---

## Requirements Mapping

| AC | Functional Requirement | Notes |
|----|----------------------|-------|
| AC1 | FR9 | Share generation |
| AC2 | FR9 | Expiration |
| AC3 | FR9 | Read-only |
| AC4 | FR9 | CTA |
| AC5 | FR9 | URL format |
| AC6 | FR9 | Clipboard |
| AC7 | FR9 | Social preview |
| AC8 | NFR9 | Rate limiting |

---

## ðŸ¤– CodeRabbit Integration

> **CodeRabbit Integration**: Enabled

### Story Type Analysis

- **Primary Type**: Deployment
- **Secondary Type(s)**: Backend (API), Frontend (share view)
- **Complexity**: High (requires backend for share links)

### Specialized Agent Assignment

- **Primary Agents**: @dev, @github-devops (deployment)
- **Supporting Agents**: None

### Quality Gate Tasks

- [ ] Pre-Commit (@dev): Run `coderabbit --prompt-only -t uncommitted` before marking story complete
- [ ] Pre-PR (@github-devops): Run `coderabbit --prompt-only --base main` before creating pull request

### CodeRabbit Focus Areas

**Primary Focus:**
- Share ID generation is unique and unpredictable (UUID or nanoid)
- 24-hour expiration logic is accurate
- Rate limiting prevents abuse (5/hour per IP)
- Read-only view enforced (no filters/export)

**Secondary Focus:**
- Copy to clipboard provides feedback
- Open Graph tags configured correctly
- Share URL is clean and readable

### Self-Healing Configuration

```
Expected Self-Healing:
  - Primary Agent: @dev (light mode)
  - Max Iterations: 2
  - Timeout: 15 minutes
  - Severity Filter: CRITICAL only
```

---

## Dev Notes

### Architecture Decision [Source: PRD Technical Assumptions]

**MVP Simplification:** For 30-day challenge, skip server-side share generation.

**Alternative:** Generate shareable client-side URL with encoded data:

```typescript
// Client-side share: encode data in URL hash
const shareData = btoa(JSON.stringify(transactions));
const shareUrl = `${window.location.origin}#/share/${shareData}`;

// Limit: URL length ~2000 chars (browser limit)
// Works for small datasets, fails for large
```

**Post-MVP:** Use Vercel Blob storage with serverless functions.

### Client-Side Implementation (MVP)

**Share ID Generation:**

```typescript
import { nanoid } from 'nanoid';  // Or simple UUID

function generateShareId(): string {
  return nanoid(8);  // 8 character random string
}
```

**Share URL Format [AC: 5]:**

```
https://yourapp.com/share/abc12345
```

### Data Storage (MVP Approach)

**Option 1: URL Hash (Limited)**

```typescript
// Encode transaction data in URL
const encodedData = btoa(JSON.stringify({
  transactions: transactions.slice(0, 100),  // Limit for URL length
  summary: summary,
  generatedAt: Date.now()
}));

const shareUrl = `${window.location.origin}/#/share/${encodedData}`;
```

**Limit:** Only works for small datasets (< ~100 transactions).

**Option 2: LocalStorage (Better)**

```typescript
// Store in localStorage, share ID only
const shareId = generateShareId();
const shareData = {
  transactions,
  summary,
  generatedAt: Date.now(),
  expiresAt: Date.now() + (24 * 60 * 60 * 1000)  // 24h
};

localStorage.setItem(`share-${shareId}`, JSON.stringify(shareData));
const shareUrl = `${window.location.origin}/share/${shareId}`;
```

**Limit:** Data only accessible on same device.

**Post-MVP:** Server-side storage with Vercel Blob.

### Share View Component [AC: 3, 4]

Location: `src/pages/ShareView.tsx`

```tsx
export default function ShareView() {
  const { shareId } = useParams();
  const [data, setData] = useState<ShareData | null>(null);

  useEffect(() => {
    // Load from localStorage
    const stored = localStorage.getItem(`share-${shareId}`);
    if (stored) {
      const parsed = JSON.parse(stored);

      // Check expiration
      if (parsed.expiresAt < Date.now()) {
        setData({ expired: true });
        return;
      }

      setData(parsed);
    }
  }, [shareId]);

  if (!data) return <ShareNotFound />;
  if (data.expired) return <ShareExpired />;

  return (
    <div className="read-only-banner">
      <p>ðŸ”’ VisualizaÃ§Ã£o apenas leitura</p>
      <Countdown expiresAt={data.expiresAt} />
    </div>
    <DashboardView transactions={data.transactions} readonly />
    <CTA />
  );
}
```

### Expiration Display [AC: 2]

```typescript
function Countdown({ expiresAt }: { expiresAt: number }) {
  const [timeLeft, setTimeLeft] = useState('');

  useEffect(() => {
    const update = () => {
      const diff = expiresAt - Date.now();
      const hours = Math.floor(diff / (1000 * 60 * 60));
      const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      setTimeLeft(`${hours}h ${minutes}m`);
    };

    update();
    const interval = setInterval(update, 60000);  // Every minute
    return () => clearInterval(interval);
  }, [expiresAt]);

  return <span>Expira em {timeLeft}</span>;
}
```

### Copy to Clipboard [AC: 6]

```typescript
async function copyToClipboard(text: string): Promise<boolean> {
  try {
    await navigator.clipboard.writeText(text);
    return true;
  } catch {
    return false;
  }
}

// Usage
const [copied, setCopied] = useState(false);

async function handleCopy() {
  const success = await copyToClipboard(shareUrl);
  if (success) {
    setCopied(true);
    setTimeout(() => setCopied(false), 3000);
  }
}

<button onClick={handleCopy}>
  {copied ? 'Copiado!' : 'Copiar link'}
</button>
```

### Open Graph Tags [AC: 7]

Location: `index.html` or react-helmet

```html
<meta property="og:title" content="Minhas finanÃ§as" />
<meta property="og:description" content="Confira minhas visualizaÃ§Ãµes financeiras" />
<meta property="og:image" content="/og-image.png" />
<meta property="og:url" content={shareUrl} />
<meta property="og:type" content="website" />
```

For dynamic OG tags, use Vercel OG or similar.

### Rate Limiting [AC: 8]

```typescript
// Client-side rate limiting
const RATE_LIMIT = 5;  // 5 shares per hour
const RATE_WINDOW = 60 * 60 * 1000;  // 1 hour

function checkRateLimit(shareId: string): boolean {
  const key = `share-rate-limit-${shareId}`;
  const stored = localStorage.getItem(key);

  if (!stored) {
    // First share this hour
    const rateData = {
      count: 1,
      windowStart: Date.now()
    };
    localStorage.setItem(key, JSON.stringify(rateData));
    return true;
  }

  const rateData = JSON.parse(stored);
  const now = Date.now();

  // Reset if window expired
  if (now - rateData.windowStart > RATE_WINDOW) {
    rateData.count = 1;
    rateData.windowStart = now;
    localStorage.setItem(key, JSON.stringify(rateData));
    return true;
  }

  // Check limit
  if (rateData.count >= RATE_LIMIT) {
    return false;
  }

  // Increment count
  rateData.count++;
  localStorage.setItem(key, JSON.stringify(rateData));
  return true;
}
```

### Read-Only Enforcement [AC: 3]

Hide filter controls and export buttons in share mode:

```tsx
<DashboardView
  transactions={transactions}
  readonly={isShareMode}  // Hides filters/export
/>
```

```tsx
{!readonly && (
  <FilterPanel />
)}
```

---

## Tasks / Subtasks

### Task 1: Install nanoid (Setup)

- Run `npm install nanoid`
- Or use crypto.randomUUID() (built-in)

### Task 2: Implement Share ID Generation (AC: 1, 5)

- Create `generateShareId()` function
- Generate unique 8-character ID
- Return share URL

### Task 3: Implement Data Storage (AC: 1)

- Use localStorage for MVP
- Store transactions + summary + expiration
- Create share data structure

### Task 4: Create Share Route (AC: 1, 5)

- Add `/share/:id` route
- Parse shareId from URL
- Load data from localStorage

### Task 5: Implement Expiration Logic (AC: 2)

- Check expiresAt on load
- Show countdown timer
- Display expired message if past due

### Task 6: Create Read-Only View (AC: 3)

- Create share view component
- Hide filters
- Hide export buttons
- Show "read-only" banner

### Task 7: Add CTA Component (AC: 4)

- Create "Create your own" button
- Links to home page
- Style prominently

### Task 8: Implement Copy to Clipboard (AC: 6)

- Create copy function
- Add share button
- Show success feedback

### Task 9: Configure Open Graph Tags (AC: 7)

- Add meta tags to index.html
- Or use react-helmet
- Configure for social preview

### Task 10: Implement Rate Limiting (AC: 8)

- Create rate limiting function
- Check localStorage for previous shares
- Enforce 5/hour limit
- Show error if exceeded

### Task 11: Create Tests (Coverage)

- Test share ID generation
- Test data storage/retrieval
- Test expiration logic
- Test rate limiting
- Test copy to clipboard

---

## Testing Strategy

### Unit Tests (Vitest)

- Share ID format (8 characters)
- Expiration calculation
- Rate limiting logic
- Copy to clipboard

### Integration Tests

- Share flow: generate â†’ store â†’ load â†’ display
- Share view is read-only
- Expired shares show correct message

### Manual Testing

1. Generate share link
2. Copy link and open in new tab
3. Verify read-only mode
4. Check expiration countdown
5. Test rate limit (try to create 6 shares)
6. Test social preview (use URL debugger)

---

## Definition of Done

- [x] All acceptance criteria met
- [x] Share button generates unique URL
- [x] 24-hour expiration with countdown
- [x] Share view is read-only
- [x] CTA displayed
- [x] URL short and readable
- [x] Copy to clipboard working
- [x] Open Graph tags configured
- [x] Rate limiting enforced
- [x] Tests passing
- [x] CodeRabbit review passed

---

*Story created by AIOS Framework*
*Scrum Master: @sm (River)*
*Date: 2026-02-03*
