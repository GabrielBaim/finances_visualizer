# Story 1.3: CSV Parser for Inter Format

## Story Metadata

```yaml
epic: 1
story: 3
title: CSV Parser for Inter Format
status: Draft
created: 2026-02-03
estimated_days: 1.5
complexity: Medium

clickup:
  task_id: ""
  epic_task_id: ""
  list: "Backlog"
  url: ""
  last_sync: ""
```

---

## User Story

**As a** user with an Inter CSV export,
**I want** to upload my file and have it parsed correctly,
**so that** I can see my transaction data visualized.

---

## Acceptance Criteria

1. Inter CSV format auto-detected (different column structure than Nubank)
2. Parser handles Inter's specific format (columns may differ)
3. Normalizes to same `Transaction[]` type as Nubank
4. Date parsing handles Inter's date format if different
5. Amount parsing handles Inter's format (positive/negative vs separate column)
6. Same validation and error handling as Story 1.2
7. Document Inter format in code comments for community contribution

---

## Requirements Mapping

| AC | Functional Requirement | Notes |
|----|----------------------|-------|
| AC1 | FR2, FR3 | Format detection |
| AC2 | FR3 | Inter-specific parsing |
| AC3 | FR3 | Normalization |
| AC4 | FR3 | Date handling |
| AC5 | FR3 | Amount handling |
| AC6 | FR2, FR11 | Validation + errors |
| AC7 | Documentation | Community contribution |

---

## ü§ñ CodeRabbit Integration

> **CodeRabbit Integration**: Enabled

### Story Type Analysis

- **Primary Type**: Frontend
- **Secondary Type(s)**: API (data parsing)
- **Complexity**: Medium (similar to 1.2, different format)

### Specialized Agent Assignment

- **Primary Agents**: @dev (parser extension)
- **Supporting Agents**: None

### Quality Gate Tasks

- [ ] Pre-Commit (@dev): Run `coderabbit --prompt-only -t uncommitted` before marking story complete
- [ ] Pre-PR (@github-devops): Run `coderabbit --prompt-only --base main` before creating pull request

### CodeRabbit Focus Areas

**Primary Focus:**
- Inter CSV format properly detected vs Nubank
- Normalization produces same Transaction[] structure
- Date and amount parsing handle Inter differences
- Code comments document Inter format for community

**Secondary Focus:**
- Reuses error handling from Story 1.2
- Validation consistent with Nubank parser

### Self-Healing Configuration

```
Expected Self-Healing:
  - Primary Agent: @dev (light mode)
  - Max Iterations: 2
  - Timeout: 15 minutes
  - Severity Filter: CRITICAL only
```

---

## Dev Notes

### Inter CSV Format [Source: PRD Epic 1]

**Note:** Inter format may differ from Nubank. Need to research actual Inter export format.

**Possible Inter Format (to be verified):**
```
Data,Lan√ßamento,Valor,Saldo,Descri√ß√£o,Categoria
15/01/2024,15/01/2024,-50.00,5000.00,"Uber Eats","Alimenta√ß√£o"
16/01/2024,16/01/2024,5000.00,10000.00,"Sal√°rio",""
```

**Key Differences from Nubank:**
- Date format: DD/MM/YYYY vs YYYY-MM-DD
- Amount may be in separate column or always positive
- May have additional columns (Saldo, Categoria)
- May use different column names

### Parser Extension Strategy

Location: `src/lib/csv-parser.ts` (extend from Story 1.2)

**Add Function:**
- `parseInterCSV(csvText: string): Transaction[]`

**Reuse from Story 1.2:**
- `Transaction` type
- `validateTransaction()` function
- Error handling patterns
- `detectBankFormat()` - update to include Inter

### Format Detection Logic [Source: Story 1.2]

Update `detectBankFormat()` to check:

```typescript
function detectBankFormat(csvText: string): 'nubank' | 'inter' | 'unknown' {
  const lines = csvText.split('\n').slice(0, 5); // Check first 5 lines
  const headers = lines[0].toLowerCase();

  // Check for Nubank columns
  if (headers.includes('data') && headers.includes('descricao') && headers.includes('valor')) {
    return 'nubank';
  }

  // Check for Inter columns
  if (headers.includes('data') && (headers.includes('lan√ßamento') || headers.includes('descri√ß√£o'))) {
    return 'inter';
  }

  return 'unknown';
}
```

### Normalization Requirements

Regardless of source format, output must be:

```typescript
Transaction {
  id: string;           // UUID or generated
  date: Date;           // Always Date object
  description: string;  // Clean description
  amount: number;       // Always positive
  type: 'income' | 'expense';  // Explicit type
  category?: string;
  source: 'nubank' | 'inter';  // Track source
}
```

### Documentation Requirement [AC: 7]

Add JSDoc comments to `parseInterCSV()`:

```typescript
/**
 * Parse Inter bank CSV export format
 *
 * Inter Format (example - may vary):
 * - Date: DD/MM/YYYY
 * - Amount: Negative for expenses OR separate column
 * - Columns: Data, Lan√ßamento, Valor, Saldo, Descri√ß√£o
 *
 * @param csvText - Raw CSV text from Inter export
 * @returns Normalized Transaction[] compatible with rest of app
 *
 * @see parseNubankCSV() for Nubank format
 */
```

---

## Tasks / Subtasks

### Task 1: Research Inter CSV Format (AC: 1, 2)

- Obtain real Inter CSV export sample
- Document column structure
- Note date format differences
- Note amount format differences

### Task 2: Update Format Detection (AC: 1)

- Modify `detectBankFormat()` in `src/lib/csv-parser.ts`
- Add Inter column detection
- Test detection with both formats

### Task 3: Implement Inter Parser (AC: 2, 3, 4, 5)

- Create `parseInterCSV()` function
- Handle Inter date format (DD/MM/YYYY ‚Üí Date)
- Handle Inter amount format
- Normalize to Transaction[]
- Set `source: 'inter'`

### Task 4: Reuse Validation (AC: 6)

- Use existing `validateTransaction()` from Story 1.2
- Ensure consistent error messages
- Test with Inter samples

### Task 5: Document Format (AC: 7)

- Add JSDoc comments to parser
- Document Inter column structure
- Add examples in comments
- Note assumptions and limitations

### Task 6: Create Tests (Coverage)

- Test Inter format detection
- Test Inter CSV parsing
- Test normalization
- Test with real Inter samples

### Task 7: Update FileUpload Component

- Update to handle both formats
- Show which format was detected
- Test both Nubank and Inter uploads

---

## Testing Strategy

### Unit Tests (Vitest)

- Inter format detection
- Inter CSV parsing with sample data
- Date format conversion (DD/MM/YYYY)
- Amount normalization

### Integration Tests

- Upload Inter CSV
- Verify correct format detected
- Verify Transaction[] output

### Manual Testing

1. Upload real Inter CSV export
2. Verify format detected correctly
3. Verify all transactions parsed
4. Compare Nubank vs Inter outputs (should be identical structure)
5. Test error handling

---

## Definition of Done

- [x] All acceptance criteria met
- [x] Inter CSV format detected correctly
- [x] Parser produces normalized Transaction[]
- [x] Date and amount parsing handle Inter differences
- [x] Code documented for community contribution
- [x] Reuses validation/error handling from 1.2
- [x] Tests passing
- [x] CodeRabbit review passed

---

*Story created by AIOS Framework*
*Scrum Master: @sm (River)*
*Date: 2026-02-03*
