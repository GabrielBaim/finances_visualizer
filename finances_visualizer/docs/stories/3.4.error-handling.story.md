# Story 3.4: Error Handling and Edge Cases

## Story Metadata

```yaml
epic: 3
story: 4
title: Error Handling and Edge Cases
status: Draft
created: 2026-02-03
estimated_days: 1.5
complexity: Low

clickup:
  task_id: ""
  epic_task_id: ""
  list: "Backlog"
  url: ""
  last_sync: ""
```

---

## User Story

**As a** user,
**I want** clear error messages when something goes wrong,
**so that** I understand what happened and how to fix it.

---

## Acceptance Criteria

1. Invalid CSV format: "Formato n√£o suportado. Use Nubank ou Inter."
2. Empty CSV: "Arquivo vazio. Verifique e tente novamente."
3. Malformed rows: "X linhas com erro foram ignoradas."
4. File too large: "Arquivo muito grande. M√°ximo 10MB."
5. Network error (if using any API): "Erro de conex√£o. Tente novamente."
6. Fallback UI for JavaScript disabled
7. Export failed: "Erro ao exportar. Tente novamente."
8. All errors show appropriate icon + retry action

---

## Requirements Mapping

| AC | Functional Requirement | Notes |
|----|----------------------|-------|
| AC1 | FR2, FR11 | Format validation |
| AC2 | FR11 | Empty file |
| AC3 | FR11 | Malformed data |
| AC4 | FR11 | File size |
| AC5 | FR11 | Network error |
| AC6 | - | No JS fallback |
| AC7 | FR11 | Export error |
| AC8 | FR10 | User feedback |

---

## ü§ñ CodeRabbit Integration

> **CodeRabbit Integration**: Enabled

### Story Type Analysis

- **Primary Type**: Frontend
- **Secondary Type(s)**: None
- **Complexity**: Low (error messages, validation)

### Specialized Agent Assignment

- **Primary Agents**: @dev (error handling)
- **Supporting Agents**: None

### Quality Gate Tasks

- [ ] Pre-Commit (@dev): Run `coderabbit --prompt-only -t uncommitted` before marking story complete
- [ ] Pre-PR (@github-devops): Run `coderabbit --prompt-only --base main` before creating pull request

### CodeRabbit Focus Areas

**Primary Focus:**
- Error messages are clear and actionable (Portuguese)
- Error types cover all edge cases in requirements
- All errors provide retry instructions
- Icons match error types

**Secondary Focus:**
- Error messages don't expose internal details
- Fallback UI works without JavaScript
- Tone is helpful, not blaming

### Self-Healing Configuration

```
Expected Self-Healing:
  - Primary Agent: @dev (light mode)
  - Max Iterations: 2
  - Timeout: 15 minutes
  - Severity Filter: CRITICAL only
```

---

## Dev Notes

### Error Types

```typescript
enum ErrorType {
  INVALID_FORMAT = 'INVALID_FORMAT',
  EMPTY_FILE = 'EMPTY_FILE',
  MALFORMED_ROWS = 'MALFORMED_ROWS',
  FILE_TOO_LARGE = 'FILE_TOO_LARGE',
  NETWORK_ERROR = 'NETWORK_ERROR',
  EXPORT_FAILED = 'EXPORT_FAILED',
  UNKNOWN_ERROR = 'UNKNOWN_ERROR'
}
```

### Error Messages Structure

```typescript
interface ErrorMessage {
  type: ErrorType;
  title: string;
  message: string;
  icon: string;
  action?: {
    label: string;
    onClick: () => void;
  };
}
```

### Error Components

Location: `src/components/ErrorDisplay.tsx`

```tsx
interface ErrorDisplayProps {
  error: ErrorMessage;
}

export function ErrorDisplay({ error }: ErrorDisplayProps) {
  return (
    <div className="bg-rose-500/10 border border-rose-500/30 rounded-lg p-4">
      <div className="flex items-start gap-3">
        <span className="text-2xl">{error.icon}</span>
        <div className="flex-1">
          <h3 className="text-rose-400 font-semibold">{error.title}</h3>
          <p className="text-slate-300 text-sm mt-1">{error.message}</p>
          {error.action && (
            <button
              onClick={error.action.onClick}
              className="mt-3 px-4 py-2 bg-rose-500 hover:bg-rose-600 text-white rounded-lg transition-colors"
            >
              {error.action.label}
            </button>
          )}
        </div>
      </div>
    </div>
  );
}
```

### Error Messages [AC: 1-7]

```typescript
const ERROR_MESSAGES: Record<ErrorType, Omit<ErrorMessage, 'type'>> = {
  [ErrorType.INVALID_FORMAT]: {
    title: 'Formato n√£o suportado',
    message: 'Use arquivos CSV exportados do Nubank ou Inter.',
    icon: '‚ùå',
    action: {
      label: 'Ver formatos suportados',
      onClick: () => scrollTo('#supported-formats')
    }
  },

  [ErrorType.EMPTY_FILE]: {
    title: 'Arquivo vazio',
    message: 'Verifique o arquivo e tente novamente.',
    icon: 'üìÇ',
    action: {
      label: 'Escolher outro arquivo',
      onClick: () => triggerFileInput()
    }
  },

  [ErrorType.MALFORMED_ROWS]: {
    title: 'Linhas com erro encontradas',
    message: (count: number) => `${count} linhas foram ignoradas. O restante foi processado.`,
    icon: '‚ö†Ô∏è',
  },

  [ErrorType.FILE_TOO_LARGE]: {
    title: 'Arquivo muito grande',
    message: 'O tamanho m√°ximo √© 10MB. Compacte ou divida seu arquivo.',
    icon: 'üìè',
  },

  [ErrorType.NETWORK_ERROR]: {
    title: 'Erro de conex√£o',
    message: 'N√£o foi poss√≠vel conectar ao servidor. Tente novamente.',
    icon: 'üåê',
    action: {
      label: 'Tentar novamente',
      onClick: () => retry()
    }
  },

  [ErrorType.EXPORT_FAILED]: {
    title: 'Erro ao exportar',
    message: 'N√£o foi poss√≠vel gerar o arquivo. Tente novamente.',
    icon: 'üì•',
    action: {
      label: 'Tentar novamente',
      onClick: () => retryExport()
    }
  },

  [ErrorType.UNKNOWN_ERROR]: {
    title: 'Erro inesperado',
    message: 'Ocorreu um erro. Tente novamente.',
    icon: '‚ö†Ô∏è',
    action: {
      label: 'Tentar novamente',
      onClick: () => location.reload()
    }
  }
};
```

### Validation Logic [AC: 1, 2, 4]

```typescript
function validateFile(file: File): { valid: boolean; error?: ErrorType } {
  // Check file size
  const MAX_SIZE = 10 * 1024 * 1024;  // 10MB
  if (file.size > MAX_SIZE) {
    return { valid: false, error: ErrorType.FILE_TOO_LARGE };
  }

  // Check file type
  if (file.type !== 'text/csv' && !file.name.endsWith('.csv')) {
    return { valid: false, error: ErrorType.INVALID_FORMAT };
  }

  return { valid: true };
}
```

### Malformed Rows Handling [AC: 3]

From CSV parser (Story 1.2):

```typescript
let errorCount = 0;
const transactions: Transaction[] = [];

results.data.forEach((row: any, index: number) => {
  const validation = validateTransaction(row);

  if (!validation.valid) {
    errorCount++;
    console.warn(`Row ${index + 1} invalid:`, validation.errors);
    return;  // Skip this row
  }

  transactions.push(normalizeTransaction(row));
});

if (errorCount > 0) {
  showErrorMessage(ErrorType.MALFORMED_ROWS, errorCount);
}
```

### No JavaScript Fallback [AC: 6]

```html
<noscript>
  <div style="padding: 2rem; text-align: center;">
    <h1>JavaScript √© necess√°rio</h1>
    <p>Este aplicativo requer JavaScript para funcionar.</p>
    <p>Por favor, habilite o JavaScript no seu navegador e recarregue a p√°gina.</p>
  </div>
</noscript>
```

### Error State Management

```tsx
const [error, setError] = useState<ErrorMessage | null>(null);

function FileUploadComponent() {
  const handleFileUpload = async (file: File) => {
    // Clear previous errors
    setError(null);

    // Validate
    const validation = validateFile(file);
    if (!validation.valid) {
      setError(ERROR_MESSAGES[validation.error!]);
      return;
    }

    // Process file
    try {
      const transactions = await parseCSV(file);

      if (transactions.length === 0) {
        setError(ERROR_MESSAGES[ErrorType.EMPTY_FILE]);
        return;
      }

      // Success - clear errors
      setError(null);
      // ... continue processing

    } catch (err) {
      setError(ERROR_MESSAGES[ErrorType.UNKNOWN_ERROR]);
    }
  };

  return (
    <div>
      {error && <ErrorDisplay error={error} />}
      <FileUploader onFileSelect={handleFileUpload} />
    </div>
  );
}
```

---

## Tasks / Subtasks

### Task 1: Create Error Types (AC: 1-8)

- Define ErrorType enum
- Create ErrorMessage interface
- Define error message constants

### Task 2: Create Error Display Component (AC: 8)

- Create `src/components/ErrorDisplay.tsx`
- Style with dark theme
- Add icon + message + action

### Task 3: Implement File Validation (AC: 1, 2, 4)

- Create `validateFile()` function
- Check file type
- Check file size
- Return error type if invalid

### Task 4: Add Malformed Rows Handling (AC: 3)

- Update CSV parser (Story 1.2)
- Count malformed rows
- Display warning with count

### Task 5: Implement Network Error Handling (AC: 5)

- Add try/catch for fetch calls
- Display network error message
- Add retry button

### Task 6: Add Export Error Handling (AC: 7)

- Wrap export functions in try/catch
- Display export error message
- Add retry button

### Task 7: Create NoScript Fallback (AC: 6)

- Add `<noscript>` tag to index.html
- Style appropriately
- Provide helpful message

### Task 8: Create Error State Hook (Integration)

- Create `useErrorHandler()` hook
- Manage error state
- Provide clear/reset methods

### Task 9: Add Icons to All Errors (AC: 8)

- Use emoji or icon library
- Match error type to icon
- Ensure readability

### Task 10: Create Tests (Coverage)

- Test validation for each error type
- Test error messages display
- Test retry actions
- Test malformed rows handling

---

## Testing Strategy

### Unit Tests (Vitest)

- File validation logic
- Error message generation
- Error state management

### Manual Testing

1. Upload invalid file type
2. Upload empty file
3. Upload file > 10MB
4. Upload CSV with malformed rows
5. Trigger network error (disconnect)
6. Test export failure
7. Disable JavaScript and view fallback

---

## Definition of Done

- [x] All acceptance criteria met
- [x] Error messages for all edge cases
- [x] Messages in Portuguese
- [x] Icons on all errors
- [x] Retry actions provided
- [x] NoScript fallback working
- [x] Export errors handled
- [x] Tests passing
- [x] CodeRabbit review passed

---

*Story created by AIOS Framework*
*Scrum Master: @sm (River)*
*Date: 2026-02-03*
