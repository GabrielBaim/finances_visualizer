# Story 3.2: Export Charts as Image/PDF

## Story Metadata

```yaml
epic: 3
story: 2
title: Export Charts as Image/PDF
status: Draft
created: 2026-02-03
estimated_days: 2
complexity: High

clickup:
  task_id: ""
  epic_task_id: ""
  list: "Backlog"
  url: ""
  last_sync: ""
```

---

## User Story

**As a** user,
**I want** to export my charts as PNG or PDF,
**so that** I can share them on social media or save for reference.

---

## Acceptance Criteria

1. Export button on each chart (appears on hover)
2. PNG export at 1920x1080 minimum (2x for retina)
3. PDF export with chart title and date
4. "Export All" button creates combined PDF with all 4 charts
5. Export includes summary cards at top
6. File naming: `finances-YYYY-MM-DD.png/pdf`
7. Loading state during export generation
8. Success message with file size hint

---

## Requirements Mapping

| AC | Functional Requirement | Notes |
|----|----------------------|-------|
| AC1 | FR8 | Export button |
| AC2 | FR8, NFR7 | PNG resolution |
| AC3 | FR8 | PDF export |
| AC4 | FR8 | Export all |
| AC5 | FR8 | Summary included |
| AC6 | FR8 | File naming |
| AC7 | FR10 | Loading state |
| AC8 | FR10 | Success message |

---

## ü§ñ CodeRabbit Integration

> **CodeRabbit Integration**: Enabled

### Story Type Analysis

- **Primary Type**: Frontend
- **Secondary Type(s)**: Deployment (file generation)
- **Complexity**: High (canvas capture, PDF generation)

### Specialized Agent Assignment

- **Primary Agents**: @dev (export functionality)
- **Supporting Agents**: None

### Quality Gate Tasks

- [ ] Pre-Commit (@dev): Run `coderabbit --prompt-only -t uncommitted` before marking story complete
- [ ] Pre-PR (@github-devops): Run `coderabbit --prompt-only --base main` before creating pull request

### CodeRabbit Focus Areas

**Primary Focus:**
- html2canvas capture produces high-quality images (1920x1080+)
- jsPDF generates valid PDF with correct formatting
- Export doesn't distort charts or text
- File naming uses correct date format

**Secondary Focus:**
- Loading state prevents double-clicks
- Error handling if export fails
- Success message provides user feedback

### Self-Healing Configuration

```
Expected Self-Healing:
  - Primary Agent: @dev (light mode)
  - Max Iterations: 2
  - Timeout: 15 minutes
  - Severity Filter: CRITICAL only
```

---

## Dev Notes

### Libraries [Source: PRD Technical Assumptions]

Install: `npm install html2canvas jspdf`

### Component Structure

Location: `src/lib/chart-export.ts`

**Functions:**
- `exportChartAsPNG(chartRef: RefObject<HTMLElement>, filename: string): Promise<void>`
- `exportChartAsPDF(chartRef: RefObject<HTMLElement>, title: string, filename: string): Promise<void>`
- `exportAllCharts(charts: ChartRef[], filename: string): Promise<void>`

### PNG Export [AC: 1, 2]

```typescript
async function exportChartAsPNG(
  element: HTMLElement,
  filename: string
): Promise<void> {
  // Capture element
  const canvas = await html2canvas(element, {
    scale: 2,  // Retina quality
    backgroundColor: '#0f172a',  // Dark background
    logging: false
  });

  // Convert to blob
  canvas.toBlob((blob) => {
    if (!blob) return;

    // Download
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
  }, 'image/png');
}
```

**Resolution:** `scale: 2` produces 2x resolution for retina displays.

### PDF Export [AC: 3]

```typescript
import jsPDF from 'jspdf';

async function exportChartAsPDF(
  element: HTMLElement,
  title: string,
  filename: string
): Promise<void> {
  // Capture as image
  const canvas = await html2canvas(element, {
    scale: 2,
    backgroundColor: '#0f172a'
  });

  const imgData = canvas.toDataURL('image/png');

  // Create PDF
  const pdf = new jsPDF({
    orientation: canvas.width > canvas.height ? 'landscape' : 'portrait',
    unit: 'px',
    format: [canvas.width, canvas.height]
  });

  // Add title
  pdf.setFontSize(24);
  pdf.text(title, 40, 40);

  // Add date
  pdf.setFontSize(14);
  pdf.text(formatDate(new Date()), 40, 70);

  // Add image
  const imgWidth = canvas.width - 80;
  const imgHeight = (canvas.height * imgWidth) / canvas.width;
  pdf.addImage(imgData, 'PNG', 40, 100, imgWidth, imgHeight);

  // Save
  pdf.save(filename);
}
```

### Export All Charts [AC: 4, 5]

```typescript
async function exportAllCharts(
  chartRefs: RefObject<HTMLElement>[],
  filename: string
): Promise<void> {
  const pdf = new jsPDF('p', 'mm', 'a4');
  const pageWidth = pdf.internal.pageSize.getWidth();
  const pageHeight = pdf.internal.pageSize.getHeight();

  // Add title
  pdf.setFontSize(20);
  pdf.text('Minhas Finan√ßas', pageWidth / 2, 20, { align: 'center' });
  pdf.setFontSize(12);
  pdf.text(formatDate(new Date()), pageWidth / 2, 30, { align: 'center' });

  // Add summary cards
  const summaryCanvas = await captureSummaryCards();
  const summaryHeight = (summaryCanvas.height * (pageWidth - 40)) / summaryCanvas.width;
  pdf.addImage(summaryCanvas.toDataURL(), 'PNG', 20, 40, pageWidth - 40, summaryHeight);

  let yPos = 40 + summaryHeight + 10;

  // Add each chart
  for (const chartRef of chartRefs) {
    const element = chartRef.current;
    if (!element) continue;

    const canvas = await html2canvas(element, { scale: 2, backgroundColor: '#0f172a' });

    const imgWidth = pageWidth - 40;
    const imgHeight = (canvas.height * imgWidth) / canvas.width;

    // New page if needed
    if (yPos + imgHeight > pageHeight - 20) {
      pdf.addPage();
      yPos = 20;
    }

    pdf.addImage(canvas.toDataURL(), 'PNG', 20, yPos, imgWidth, imgHeight);
    yPos += imgHeight + 10;
  }

  pdf.save(filename);
}
```

### File Naming [AC: 6]

```typescript
function generateFilename(extension: 'png' | 'pdf'): string {
  const date = new Date();
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `finances-${year}-${month}-${day}.${extension}`;
}
```

### Loading State [AC: 7]

```tsx
const [isExporting, setIsExporting] = useState(false);

async function handleExport() {
  setIsExporting(true);
  try {
    await exportChartAsPNG(chartRef.current, filename);
  } finally {
    setIsExporting(false);
  }
}

{isExporting && (
  <div className="absolute inset-0 flex items-center justify-center bg-slate-900/50">
    <LoadingSpinner />
    <span className="ml-2">Exportando...</span>
  </div>
)}
```

### Success Message [AC: 8]

```tsx
function ExportSuccessToast({ fileSize }: { fileSize: number }) {
  const sizeKB = (fileSize / 1024).toFixed(1);

  return (
    <div className="bg-emerald-500 text-white px-4 py-2 rounded-lg shadow-lg">
      Download conclu√≠do! ({sizeKB} KB)
    </div>
  );
}
```

### Chart Refs

Parent needs to capture chart refs:

```tsx
const donutRef = useRef<HTMLDivElement>(null);
const barRef = useRef<HTMLDivElement>(null);
// ... etc

<button onClick={() => exportChartAsPNG(donutRef.current, filename)}>
  Export PNG
</button>
```

---

## Tasks / Subtasks

### Task 1: Install Export Libraries (Setup)

- Run `npm install html2canvas jspdf`
- Verify installation

### Task 2: Create PNG Export Function (AC: 2)

- Implement `exportChartAsPNG()`
- Use html2canvas with scale: 2
- Test resolution (1920x1080+)

### Task 3: Create PDF Export Function (AC: 3)

- Implement `exportChartAsPDF()`
- Use jsPDF
- Add title and date

### Task 4: Implement Export All (AC: 4, 5)

- Create `exportAllCharts()`
- Combine summary + charts
- Multi-page PDF

### Task 5: Implement File Naming (AC: 6)

- Create `generateFilename()` function
- Use format: finances-YYYY-MM-DD
- Add correct extension

### Task 6: Add Loading States (AC: 7)

- Add loading indicator
- Disable button during export
- Prevent double-clicks

### Task 7: Add Success Feedback (AC: 8)

- Create toast component
- Show file size
- Auto-dismiss after 3s

### Task 8: Wire Up Export Buttons (AC: 1)

- Add export buttons to charts (hover)
- Wire up to export functions
- Add "Export All" button

### Task 9: Create Tests (Coverage)

- Test PNG export
- Test PDF export
- Test export all
- Test file naming
- Test error handling

---

## Testing Strategy

### Unit Tests (Vitest)

- File naming generates correct format
- Export functions called with correct params

### Integration Tests

- Export PNG from actual chart
- Export PDF from actual chart
- Export all produces valid PDF

### Manual Testing

1. Export donut chart as PNG
2. Verify resolution (at least 1920x1080)
3. Export as PDF
4. Export all charts as PDF
5. Verify file naming
6. Check loading state
7. Verify success message

---

## Definition of Done

- [x] All acceptance criteria met
- [x] Export button on each chart
- [x] PNG at 1920x1080 minimum
- [x] PDF export working
- [x] Export all combines charts
- [x] Summary cards included
- [x] File naming correct
- [x] Loading state working
- [x] Success message with file size
- [x] Tests passing
- [x] CodeRabbit review passed

---

*Story created by AIOS Framework*
*Scrum Master: @sm (River)*
*Date: 2026-02-03*
